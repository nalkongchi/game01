<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ë§ˆë²•ì‚¬ ìˆ˜ë ¨ìƒ ì•„ì¹´ë°ë¯¸ ğŸ”®</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@400;700&family=Press+Start+2P&display=swap');

:root{
  --bg:#080614;--bg2:#100e22;--panel:#0e0c1e;
  --bdr:#2e2258;--bdr2:#5e44aa;
  --gold:#e8b830;--silver:#b8cce0;--text:#ddd0ff;--dim:#6858a0;
  --mana:#9050ff;--know:#40b0ff;--body:#40e880;--soc:#ffaa40;
  --red:#ff5050;--grn:#50ff90;--pink:#ff50a0;--ora:#ff9040;
  --px:'Press Start 2P',monospace;--sr:'Noto Serif KR',serif;
}
*{box-sizing:border-box;margin:0;padding:0}
body{
  background:var(--bg);
  color:var(--text);
  font-family:var(--sr);
  min-height:100vh;
  overflow-x:hidden;
  background-image:
    radial-gradient(ellipse at 15% 25%,rgba(80,40,160,.2) 0%,transparent 55%),
    radial-gradient(ellipse at 85% 75%,rgba(40,20,100,.25) 0%,transparent 55%);
}
.star{position:fixed;background:#fff;border-radius:50%;animation:tw 3s infinite;pointer-events:none;z-index:0}
@keyframes tw{0%,100%{opacity:.15}50%{opacity:.9}}
#app{position:relative;z-index:1;max-width:1080px;margin:0 auto;padding:14px}
.screen{display:none !important}
.screen.active{display:block !important}
.screen-flex.active{display:flex !important}

#screen-title{flex-direction:column;align-items:center;justify-content:center;min-height:100vh;gap:20px;text-align:center}
.box{background:var(--panel);border:2px solid var(--bdr);position:relative}
.box::after{content:'';position:absolute;inset:0;background:linear-gradient(135deg,rgba(94,68,170,.06) 0%,transparent 50%);pointer-events:none}

.btn{
  font-family:var(--px);
  font-size:10px;
  padding:12px 28px;
  background:linear-gradient(180deg,#241860 0%,#120c38 100%);
  border:2px solid var(--bdr2);
  color:var(--gold);
  cursor:pointer;
  letter-spacing:1px;
  transition:all .15s;
  text-shadow:0 0 6px var(--gold);
}
.btn:hover{
  background:linear-gradient(180deg,#341d80,#241860);
  border-color:var(--gold);
  transform:translateY(-1px);
  box-shadow:0 4px 16px rgba(232,184,48,.25)
}
.btn:active{transform:translateY(0)}
.btn:disabled{opacity:.35;cursor:default;transform:none}
.btn-sm{padding:8px 16px;font-size:8px}
.btn-xs{padding:4px 10px;font-size:7px}
.btn-red{border-color:var(--red);color:var(--red);text-shadow:0 0 6px var(--red)}
.btn-red:hover{box-shadow:0 4px 16px rgba(255,80,80,.25)}
.btn-pink{border-color:var(--pink);color:var(--pink);text-shadow:0 0 6px var(--pink)}
.btn-pink:hover{box-shadow:0 4px 16px rgba(255,80,160,.25)}

.px7{font-family:var(--px);font-size:7px}
.px8{font-family:var(--px);font-size:8px}
.px9{font-family:var(--px);font-size:9px}
.px10{font-family:var(--px);font-size:10px}
.px12{font-family:var(--px);font-size:12px}
hr.dv{border:none;border-top:1px solid var(--bdr);margin:10px 0}

/* TITLE */
.ttl-em{font-size:72px;animation:flt 4s ease-in-out infinite;filter:drop-shadow(0 0 18px #9050ff)}
@keyframes flt{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
.ttl-main{
  font-family:var(--px);
  font-size:clamp(13px,2.8vw,20px);
  color:var(--gold);
  text-shadow:0 0 18px var(--gold),2px 2px 0 #000;
  line-height:2;
}
.ttl-sub{font-family:var(--px);font-size:clamp(7px,1.3vw,10px);color:var(--dim);letter-spacing:1px}

/* CREATE */
.cg{display:grid;grid-template-columns:1fr 1fr;gap:16px}
@media(max-width:580px){.cg{grid-template-columns:1fr}}
.sec-ttl{
  font-family:var(--px);
  font-size:8px;
  color:var(--know);
  margin-bottom:10px;
  border-bottom:1px solid var(--bdr);
  padding-bottom:5px;
  text-shadow:0 0 5px var(--know)
}
.name-inp{
  width:100%;
  background:var(--bg2);
  border:2px solid var(--bdr);
  color:var(--text);
  font-family:var(--sr);
  font-size:15px;
  padding:8px 12px;
  outline:none;
  transition:border-color .2s
}
.name-inp:focus{border-color:var(--bdr2)}
.name-inp::placeholder{color:var(--dim)}
.srow{display:flex;align-items:center;gap:7px;margin-bottom:9px}
.slbl{font-family:var(--px);font-size:7px;width:54px;flex-shrink:0;line-height:1.5}
.sbw{flex:1;height:11px;background:var(--bg2);border:1px solid var(--bdr);position:relative}
.sbf{height:100%;transition:width .2s}
.sbf::after{content:'';position:absolute;top:0;left:0;right:0;height:50%;background:rgba(255,255,255,.12)}
.sn{font-family:var(--px);font-size:7px;width:20px;text-align:right;flex-shrink:0}
.s-mana .sbf{background:var(--mana)}
.s-know .sbf{background:var(--know)}
.s-body .sbf{background:var(--body)}
.s-soc .sbf{background:var(--soc)}
.sbtn{
  width:19px;height:19px;background:var(--bg2);border:1px solid var(--bdr);color:var(--text);
  cursor:pointer;font-size:11px;display:flex;align-items:center;justify-content:center;transition:background .1s
}
.sbtn:hover{background:var(--bdr2)}

/* HUD */
.hud{display:grid;grid-template-columns:auto 1fr auto;align-items:center;gap:12px;padding:9px 13px;margin-bottom:10px}
.hd-name{font-family:var(--px);font-size:11px;color:var(--gold)}
.hd-date{font-family:var(--px);font-size:9px;color:var(--gold);text-align:center}
.hd-gold{font-family:var(--px);font-size:10px;color:var(--gold);text-align:right}
.prog{width:100%;height:6px;background:var(--bg2);border:1px solid var(--bdr);margin-top:4px}
.progf{height:100%;background:linear-gradient(90deg,var(--mana),var(--know));transition:width .5s}
.stag{font-family:var(--px);font-size:7px;padding:2px 6px;border:1px solid;display:inline-block;margin-top:3px}
.sp{color:#90ff70;border-color:#90ff70}
.su{color:#ffe060;border-color:#ffe060}
.au{color:#ff8830;border-color:#ff8830}
.wi{color:#70c0ff;border-color:#70c0ff}

/* GAME GRID */
.gg{display:grid;grid-template-columns:188px 1fr 192px;gap:10px}
@media(max-width:750px){.gg{grid-template-columns:1fr}}

/* PANEL */
.pnl{padding:11px}
.pttl{
  font-family:var(--px);
  font-size:8px;
  color:var(--know);
  margin-bottom:9px;
  border-bottom:1px solid var(--bdr);
  padding-bottom:5px;
  text-shadow:0 0 5px var(--know)
}
.sdr{display:flex;align-items:center;gap:5px;margin-bottom:6px}
.sdlbl{font-family:var(--px);font-size:7px;width:44px;flex-shrink:0;line-height:1.4}
.sdb{flex:1;height:8px;background:var(--bg2);border:1px solid var(--bdr)}
.sdf{height:100%;transition:width .3s}
.sdn{font-family:var(--px);font-size:7px;width:22px;text-align:right;flex-shrink:0}
.sd-mana .sdf{background:var(--mana)}
.sd-know .sdf{background:var(--know)}
.sd-body .sdf{background:var(--body)}
.sd-soc .sdf{background:var(--soc)}
.mr{display:flex;justify-content:space-between;margin-bottom:4px}
.fatb{width:100%;height:6px;background:var(--bg2);border:1px solid var(--bdr);margin-bottom:7px}
.fatf{height:100%;transition:width .3s}
.badge{display:inline-block;font-family:var(--px);font-size:7px;padding:2px 5px;border:1px solid;margin:2px 2px 0 0}
.b-ok{color:var(--grn);border-color:var(--grn)}
.b-warn{color:var(--ora);border-color:var(--ora)}
.b-bad{color:var(--red);border-color:var(--red)}

/* SCHEDULE */
.sch{padding:11px}
.mi{font-family:var(--px);font-size:9px;color:var(--gold);text-align:center;margin-bottom:9px;text-shadow:0 0 7px var(--gold)}
.slots{display:grid;grid-template-columns:1fr 1fr;gap:7px;margin-bottom:9px}
.slot{padding:7px;border:1px solid var(--bdr);background:var(--bg2)}
.slot-lbl{font-family:var(--px);font-size:7px;color:var(--dim);margin-bottom:4px}
.slot-val{font-family:var(--px);font-size:7px;color:var(--mana);min-height:14px;line-height:1.6}
.slot-val.empty{color:var(--dim)}

.ag{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-bottom:9px}
@media(max-width:500px){.ag{grid-template-columns:repeat(2,1fr)}}
.ab{
  padding:7px 4px;background:var(--bg2);border:1px solid var(--bdr);color:var(--text);
  cursor:pointer;font-family:var(--sr);text-align:center;transition:all .12s;line-height:1.3
}
.ab:hover{background:var(--bdr);border-color:var(--bdr2)}
.ab.sel{border-color:var(--mana);background:#1c1050}
.ab.dis{opacity:.35;cursor:not-allowed}
.ai{font-size:17px;display:block;margin-bottom:2px}
.an{font-size:10px;display:block}
.ac{font-family:var(--px);font-size:7px;color:var(--dim);display:block;margin-top:2px;line-height:1.5}
.cat-head{
  grid-column:span 4;
  padding:4px 6px;
  font-family:var(--px);
  font-size:7px;
  color:var(--silver);
  border-left:3px solid var(--bdr2);
  background:rgba(94,68,170,.12);
}
@media(max-width:500px){.cat-head{grid-column:span 2}}

/* NPC */
.np{padding:11px}
.nc{
  display:flex;align-items:center;gap:6px;padding:6px 8px;background:var(--bg2);
  border:1px solid var(--bdr);cursor:pointer;transition:all .12s;margin-bottom:5px
}
.nc:hover{background:#1c1840;border-color:var(--bdr2)}
.nc.locked{opacity:.4;cursor:default}
.ni{font-size:16px;flex-shrink:0}
.nn{font-family:var(--px);font-size:7px;display:block;margin-bottom:2px}
.nh{width:100%;height:5px;background:var(--bg);border:1px solid var(--bdr)}
.nhf{height:100%;background:linear-gradient(90deg,#d04070,#f050a0);transition:width .3s}
.hnum{font-family:var(--px);font-size:7px;color:var(--pink);flex-shrink:0}

/* LOG */
.log{padding:8px 10px;max-height:120px;overflow-y:auto;margin-top:7px}
.le{
  font-family:var(--px);
  font-size:7px;
  color:var(--dim);
  margin-bottom:3px;
  line-height:1.7;
  border-left:2px solid var(--bdr);
  padding-left:5px
}
.le-ev{color:var(--ora);border-color:var(--ora)}
.le-good{color:var(--grn);border-color:var(--grn)}
.le-bad{color:var(--red);border-color:var(--red)}
.le-heart{color:var(--pink);border-color:var(--pink)}

::-webkit-scrollbar{width:4px}
::-webkit-scrollbar-track{background:var(--bg)}
::-webkit-scrollbar-thumb{background:var(--bdr)}

/* MODAL */
.ov{
  display:none;position:fixed;inset:0;background:rgba(0,0,0,.88);z-index:200;
  align-items:center;justify-content:center;backdrop-filter:blur(3px)
}
.ov.open{display:flex}
.modal{max-width:460px;width:92%;padding:24px;animation:mIn .18s ease-out}
@keyframes mIn{
  from{transform:scale(.92) translateY(16px);opacity:0}
  to{transform:scale(1) translateY(0);opacity:1}
}
.m-ico{font-size:42px;text-align:center;margin-bottom:9px}
.m-ttl{font-family:var(--px);font-size:11px;color:var(--gold);text-align:center;margin-bottom:12px;text-shadow:0 0 8px var(--gold)}
.m-txt{font-size:13px;line-height:1.85;color:var(--silver);text-align:center;margin-bottom:14px}
.m-tags{display:flex;flex-wrap:wrap;gap:5px;justify-content:center;margin-bottom:14px}
.tag{font-family:var(--px);font-size:7px;padding:3px 7px;border:1px solid;background:rgba(0,0,0,.3)}
.tp{color:var(--grn);border-color:var(--grn)}
.tn{color:var(--red);border-color:var(--red)}
.th{color:var(--pink);border-color:var(--pink)}
.m-btns{display:flex;gap:8px;justify-content:center;flex-wrap:wrap}
.choices{display:flex;flex-direction:column;gap:7px;margin-bottom:14px}
.chbtn{
  padding:9px 12px;background:var(--bg2);border:1px solid var(--bdr);color:var(--text);
  cursor:pointer;font-family:var(--sr);font-size:13px;text-align:left;transition:all .12s;line-height:1.5
}
.chbtn:hover{background:#1c1840;border-color:var(--bdr2)}

/* NPC MODAL */
.nm-ico{font-size:50px;text-align:center;margin-bottom:8px}
.nm-name{font-family:var(--px);font-size:12px;color:var(--gold);text-align:center;margin-bottom:4px}
.nm-title{font-family:var(--px);font-size:8px;color:var(--dim);text-align:center;margin-bottom:11px}
.nm-hr{display:flex;align-items:center;gap:7px;margin-bottom:9px}

/* ENDING */
#screen-ending{
  flex-direction:column;align-items:center;justify-content:center;min-height:100vh;text-align:center;
  gap:17px;padding:36px 18px
}
.en-ico{font-size:68px;animation:flt 4s ease-in-out infinite}
.en-ttl{
  font-family:var(--px);
  font-size:clamp(11px,2.4vw,17px);
  color:var(--gold);
  text-shadow:0 0 18px var(--gold);
  line-height:1.9
}
.en-txt{max-width:520px;font-size:14px;line-height:1.95;color:var(--silver)}
.en-stats{display:flex;gap:11px;flex-wrap:wrap;justify-content:center}
.en-st{padding:7px 13px;border:1px solid var(--bdr);font-family:var(--px);font-size:8px;background:var(--panel)}
.sh-item{
  display:flex;justify-content:space-between;align-items:center;padding:5px 7px;background:var(--bg2);
  border:1px solid var(--bdr);margin-bottom:5px;gap:8px
}
</style>
</head>
<body>
<div id="app">

  <!-- TITLE -->
  <div id="screen-title" class="screen screen-flex active">
    <div class="ttl-em">ğŸ”®</div>
    <div class="ttl-main">ë§ˆë²•ì‚¬ ìˆ˜ë ¨ìƒ<br>ì•„ì¹´ë°ë¯¸</div>
    <div class="ttl-sub">â€” MAGE ACADEMY v3 â€”</div>
    <div style="display:flex;gap:12px;flex-wrap:wrap;justify-content:center;margin-top:8px">
      <button class="btn" id="new-game-btn">âœ¦ ìƒˆ ê²Œì„</button>
      <button class="btn" id="load-btn" style="display:none">â–¶ ì´ì–´í•˜ê¸°</button>
    </div>
    <div class="px8" style="color:var(--dim);margin-top:14px;line-height:2.3">
      3ë…„ì˜ ìˆ˜ë ¨ ëì— ì–´ë–¤ ë§ˆë²•ì‚¬ê°€ ë  ê²ƒì¸ê°€
    </div>
  </div>

  <!-- CREATE -->
  <div id="screen-create" class="screen" style="padding:18px 0">
    <div class="px12" style="color:var(--gold);text-align:center;margin-bottom:18px;text-shadow:0 0 10px var(--gold)">âœ¦ ìˆ˜ë ¨ìƒ ë“±ë¡ âœ¦</div>
    <div class="cg">
      <div class="box" style="padding:16px">
        <div class="sec-ttl">ì´ë¦„ ì…ë ¥</div>
        <input type="text" class="name-inp" id="char-name" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" maxlength="10">
        <hr class="dv" style="margin:13px 0">
        <div class="sec-ttl">ëŠ¥ë ¥ì¹˜ ë°°ë¶„ (í¬ì¸íŠ¸: 20)</div>
        <div id="stat-alloc"></div>
        <div style="text-align:right;margin-top:5px" class="px8">ë‚¨ì€ í¬ì¸íŠ¸: <span id="pts" style="color:var(--grn)">20</span></div>
        <hr class="dv" style="margin:13px 0">
        <div style="display:flex;gap:8px;justify-content:center">
          <button class="btn btn-sm" id="back-btn">â† ë’¤ë¡œ</button>
          <button class="btn btn-sm" id="start-btn">ì‹œì‘ â†’</button>
        </div>
      </div>

      <div class="box" style="padding:16px;text-align:center">
        <div class="sec-ttl">ê²Œì„ ì•ˆë‚´</div>
        <div style="font-size:52px;margin:8px 0;filter:drop-shadow(0 0 10px #9050ff)">ğŸ§™â€â™€ï¸</div>
        <div class="px7" style="color:var(--silver);line-height:2.2">ì€ë°œ ë‹¨ë°œ Â· í•˜ëŠ˜ë¹› ëˆˆ Â· ê²€ì€ ë§í† </div>
        <hr class="dv">
        <div class="px7" style="color:var(--dim);line-height:2.6;text-align:left">
          ğŸ“… 3ë…„ = 36ê°œì›”<br>
          ğŸ’¸ ìƒí™œë¹„ ì›” 12G ìë™ ì°¨ê°<br>
          ğŸ§¹ ì•„ë¥´ë°”ì´íŠ¸ = ëˆ ë²Œê¸° / ì„±ì¥ ì ìŒ<br>
          ğŸ“š ìˆ˜ì—… = ëˆ ì“°ê¸° / ì„±ì¥ í¼<br>
          ğŸ­ ì‚¬êµ = ëˆ ì“°ê¸° / í˜¸ê°ë„Â·ì´ë²¤íŠ¸ ê°•í™”<br>
          ğŸ˜´ ë¬´ë£Œ í–‰ë™ = íšŒë³µÂ·ì†Œì„±ì¥<br>
          ğŸ“ 6ê°œì›”ë§ˆë‹¤ ì„±ì  ìš°ìˆ˜ ì‹œ ì¥í•™ê¸ˆ ì§€ê¸‰<br>
          ğŸ›Œ í”¼ë¡œ 90+ â†’ ë‹¤ìŒ ë‹¬ ê°•ì œ íœ´ì‹
        </div>
      </div>
    </div>
  </div>

  <!-- GAME -->
  <div id="screen-game" class="screen">
    <div class="box hud">
      <div>
        <div class="hd-name" id="hd-name">ìˆ˜ë ¨ìƒ</div>
        <div class="px7" style="color:var(--dim);margin-top:2px">ğŸ§™â€â™€ï¸ ë§ˆë²•ì‚¬ ìˆ˜ë ¨ìƒ</div>
      </div>
      <div style="text-align:center">
        <div class="hd-date" id="hd-date">1ë…„ì°¨ 1ì›”</div>
        <div id="hd-season"></div>
        <div class="prog"><div class="progf" id="hd-prog" style="width:0%"></div></div>
        <div class="px7" style="color:var(--dim);margin-top:2px" id="hd-turn">1/36</div>
      </div>
      <div class="hd-gold">ğŸ’° <span id="hd-gold">100</span>G</div>
    </div>

    <div class="gg">
      <!-- LEFT -->
      <div>
        <div class="box pnl">
          <div class="pttl">âœ¦ ëŠ¥ë ¥ì¹˜</div>
          <div id="stat-panel"></div>
          <hr class="dv">
          <div class="pttl">âœ¦ ìƒíƒœ</div>
          <div class="mr">
            <span class="px7" style="color:var(--dim)">í”¼ë¡œë„</span>
            <span class="px7" id="fat-num">0/100</span>
          </div>
          <div class="fatb"><div class="fatf" id="fat-fill" style="width:0%"></div></div>
          <div id="badges"></div>
        </div>

        <div class="box pnl" style="margin-top:8px">
          <div class="pttl">âœ¦ ìƒì </div>
          <div id="shop-list"></div>
        </div>
      </div>

      <!-- CENTER -->
      <div class="box sch">
        <div class="mi" id="m-info">1ë…„ì°¨ 1ì›” â€” ì´ë‹¬ì˜ í™œë™ì„ ì„ íƒí•˜ì„¸ìš”</div>

        <div class="slots">
          <div class="slot">
            <div class="slot-lbl">ğŸŒ… ì˜¤ì „</div>
            <div class="slot-val empty" id="slot-am">ì„ íƒ ì•ˆ í•¨</div>
          </div>
          <div class="slot">
            <div class="slot-lbl">ğŸŒ† ì˜¤í›„</div>
            <div class="slot-val empty" id="slot-pm">ì„ íƒ ì•ˆ í•¨</div>
          </div>
        </div>

        <div class="px7" style="color:var(--dim);margin-bottom:6px;line-height:2">
          í™œë™ ì„ íƒ (ì˜¤ì „ â†’ ì˜¤í›„ ìˆœ)<br>
          ì•„ë¥´ë°”ì´íŠ¸ëŠ” ìˆ˜ì… / ìˆ˜ì—…Â·ì‚¬êµëŠ” ë¹„ìš© / ë°ì´íŠ¸ëŠ” ì˜¤í›„ ìŠ¬ë¡¯ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
        </div>

        <div class="ag" id="act-grid"></div>
        <button class="btn" style="width:100%" id="confirm-btn">ë‹¤ìŒ ë‹¬ â†’</button>

        <div class="box log" id="log-panel"></div>
      </div>

      <!-- RIGHT -->
      <div>
        <div class="box np">
          <div class="pttl">âœ¦ ì¸ë¬¼ ê´€ê³„</div>
          <div id="npc-list"></div>
          <button class="btn btn-sm btn-pink" id="date-btn" style="display:none;width:100%;margin-top:6px">ğŸ’• ë°ì´íŠ¸ ì‹ ì²­</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ENDING -->
  <div id="screen-ending" class="screen screen-flex">
    <div class="en-ico" id="en-ico">âœ¨</div>

    <div class="en-ttl" id="en-main-ttl">ë©”ì¸ ì—”ë”©</div>
    <div class="en-txt" id="en-main-txt"></div>

    <div class="box" id="en-rom-wrap" style="max-width:520px;width:100%;padding:14px;display:none">
      <div class="px9" style="color:var(--pink);margin-bottom:10px;text-shadow:0 0 8px var(--pink)">ğŸ’• ë¡œë§¨ìŠ¤ ì—í•„ë¡œê·¸</div>
      <div class="px10" id="en-rom-ttl" style="color:var(--pink);margin-bottom:10px;line-height:1.8"></div>
      <div class="en-txt" id="en-rom-txt" style="font-size:13px;max-width:none"></div>
    </div>

    <div class="box" style="max-width:520px;width:100%;padding:14px">
      <div class="px9" style="color:var(--know);margin-bottom:10px;text-shadow:0 0 8px var(--know)">âœ¦ ìˆ˜ë ¨ ê¸°ë¡</div>
      <div id="en-meta" style="font-size:13px;line-height:2;color:var(--silver)"></div>
    </div>

    <div class="en-stats" id="en-stats"></div>

    <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-top:10px">
      <button class="btn" id="restart-btn">âœ¦ ë‹¤ì‹œ ì‹œì‘</button>
    </div>
  </div>

</div>

<!-- EVENT MODAL -->
<div class="ov" id="ev-modal">
  <div class="box modal">
    <div class="m-ico" id="ev-ico">âš¡</div>
    <div class="m-ttl" id="ev-ttl">ì œëª©</div>
    <div class="m-txt" id="ev-txt">ë‚´ìš©</div>
    <div class="m-tags" id="ev-tags"></div>
    <div class="m-btns"><button class="btn btn-sm" id="ev-close-btn">í™•ì¸</button></div>
  </div>
</div>

<!-- LOVE MODAL -->
<div class="ov" id="lv-modal">
  <div class="box modal">
    <div class="m-ico" id="lv-ico">ğŸ’•</div>
    <div class="m-ttl" id="lv-ttl">ì œëª©</div>
    <div class="m-txt" id="lv-txt">ë‚´ìš©</div>
    <div class="choices" id="lv-choices"></div>
  </div>
</div>

<!-- DATE SELECT MODAL -->
<div class="ov" id="date-modal">
  <div class="box modal">
    <div class="m-ttl">ğŸ’• ë°ì´íŠ¸ ìƒëŒ€ ì„ íƒ</div>
    <div class="m-txt px8" style="margin-bottom:10px">
      í˜¸ê°ë„ 30 ì´ìƒì¸ ì¸ë¬¼ê³¼ ë°ì´íŠ¸í•  ìˆ˜ ìˆì–´ìš”.<br>
      ë°ì´íŠ¸ëŠ” ì˜¤í›„ í™œë™ ì‹œê°„ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
    </div>
    <div class="choices" id="date-choices"></div>
    <div class="m-btns"><button class="btn btn-sm btn-red" id="date-cancel-btn">ì·¨ì†Œ</button></div>
  </div>
</div>

<!-- NPC MODAL -->
<div class="ov" id="npc-modal">
  <div class="box modal" style="max-width:370px">
    <div class="nm-ico" id="nm-ico">ğŸ¤´</div>
    <div class="nm-name" id="nm-name">ì´ë¦„</div>
    <div class="nm-title" id="nm-title">ì§í•¨</div>
    <div class="m-txt" id="nm-desc" style="margin-bottom:9px;font-size:13px"></div>

    <div class="nm-hr">
      <span class="px7" style="color:var(--dim);flex-shrink:0">í˜¸ê°ë„</span>
      <div style="flex:1;height:9px;background:var(--bg2);border:1px solid var(--bdr)">
        <div id="nm-hf" style="height:100%;background:linear-gradient(90deg,#d04070,#f050a0);transition:width .3s"></div>
      </div>
      <span class="px7" style="color:var(--pink);flex-shrink:0" id="nm-hn">0/100</span>
    </div>

    <div class="px7" style="color:var(--dim);text-align:center;margin-bottom:5px" id="nm-stage"></div>
    <div class="px7" style="color:var(--dim);text-align:center;margin-bottom:12px" id="nm-next"></div>
    <div class="m-btns"><button class="btn btn-sm" id="npc-close-btn">ë‹«ê¸°</button></div>
  </div>
</div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ë°ì´í„°
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

const SAVE_KEY = 'mageAcad_v3';

const NPCS = [
  { id:'leon',    icon:'ğŸ¤´', name:'ë ˆì˜¨',    title:'ì™•êµ­ì˜ ì™•ì',      color:'#e8b830',
    desc:'í–‡ì‚´ì²˜ëŸ¼ ë°ì€ ê¸ˆë°œì˜ ì™•ì. ì‹ ë¶„ ì°¨ì´ë¥¼ ê°œì˜ì¹˜ ì•ŠëŠ” ì²œì§„ë‚œë§Œí•œ ì²­ë…„.',
    meet: t => t >= 3,
    events: [
      { t:4,  h:6,  txt:'ì‚¬êµ íŒŒí‹°ì—ì„œ ë ˆì˜¨ ì™•ìì™€ ëˆˆì´ ë§ˆì£¼ì³¤ë‹¤. "ì™€, ì§„ì§œ ë§ˆë²•ì„ ì“°ëŠ” ê±°ì•¼?" ê·¸ê°€ ëˆˆì„ ë°˜ì§ì˜€ë‹¤.' },
      { t:12, h:8,  txt:'"ìš”ì¦˜ ìˆ˜ë ¨ì€ ì–´ë•Œ?" ì™•ìê°€ ì„± ì •ì›ì—ì„œ ë¬¼ì—ˆë‹¤. ì €ë… ë…¸ì„ì´ ê¸ˆë°œì„ ë¬¼ë“¤ì˜€ë‹¤.',
        choices:['ì†”ì§í•˜ê²Œ í˜ë“¤ë‹¤ê³  ë§í•œë‹¤','ê´œì°®ë‹¤ê³  ì›ƒì–´ë„˜ê¸´ë‹¤','ê°™ì´ ì‚°ì±…í•˜ìê³  ì œì•ˆí•œë‹¤'],
        res:[
          {h:4,txt:'"ê·¸ë ‡êµ¬ë‚˜â€¦ ê°™ì´ ë²„í‹°ì." ë ˆì˜¨ì´ ì§„ì§€í•˜ê²Œ ê³ ê°œë¥¼ ë„ë•ì˜€ë‹¤.'},
          {h:2,txt:'"ê·¸ë ‡êµ¬ë‚˜. ì–¸ì œë“  ë§í•´ì¤˜." ë ˆì˜¨ì´ ì–´ë”˜ì§€ ì•„ì‰¬ìš´ ë“¯ ë°”ë¼ë´¤ë‹¤.'},
          {h:6,txt:'í•¨ê»˜ ê±·ëŠ” ì‹œê°„ì´ ì¡°ìš©íˆ, ê·¸ë¦¬ê³  ë”°ëœ»í•˜ê²Œ í˜ë €ë‹¤.'}
        ]},
      { t:22, h:10, txt:'"ì•„ë¬´ë„ ì—†ì„ ë•Œâ€¦ ë‚˜ëŠ” ì‚¬ì‹¤ ì™¸ë¡œì›Œ." ë ˆì˜¨ì´ ì²˜ìŒìœ¼ë¡œ ì†”ì§í•˜ê²Œ ë§í–ˆë‹¤.',
        choices:['ì¡°ìš©íˆ ê³ì— ì•‰ëŠ”ë‹¤','"ë‚˜ë„ ê·¸ë˜"ë¼ê³  ë§í•œë‹¤','ì†ì„ ì¡ì•„ì¤€ë‹¤'],
        res:[
          {h:5,txt:'ë§ ì—†ì´ í•¨ê»˜ ìˆëŠ” ê²ƒë§Œìœ¼ë¡œ ì¶©ë¶„í–ˆë‹¤.'},
          {h:8,txt:'ë ˆì˜¨ì´ ëˆˆì„ í¬ê²Œ ëœ¨ë‹¤ê°€ ì‘ê²Œ ì›ƒì—ˆë‹¤. "ê·¸ë ‡êµ¬ë‚˜. ë‹¤í–‰ì´ì•¼."'},
          {h:12,txt:'ë ˆì˜¨ì´ êµ³ì–´ìˆë‹¤ê°€ ì†ì„ ê¼­ ì¥ì—ˆë‹¤.'}
        ]},
      { t:32, h:14, txt:'"ì™•ìë¹„ ê°™ì€ ê±° í•„ìš” ì—†ì–´. ê·¸ëƒ¥ ë„¤ ê³ì— ìˆê³  ì‹¶ì–´." ë ˆì˜¨ì´ ì§„ì‹¬ì„ ë‹´ì•„ ë§í–ˆë‹¤.' }
    ]},

  { id:'cassian', icon:'ğŸ—¡ï¸', name:'ì¹´ì‹œì•ˆ', title:'ì™•ì‹¤ ê·¼ìœ„ê¸°ì‚¬',    color:'#b0c0d8',
    desc:'ê³¼ë¬µí•˜ê³  ì¶©ì§í•œ ì²­ë…„ ê¸°ì‚¬. ì£¼ì¸ê³µ ì•ì—ì„œë§Œ ê°ì •ì´ í”ë“¤ë¦°ë‹¤.',
    meet: t => t >= 1,
    events: [
      { t:3,  h:5,  txt:'í›ˆë ¨ ì¤‘ ë„˜ì–´ì§„ ì£¼ì¸ê³µì—ê²Œ ì¹´ì‹œì•ˆì´ ë§ì—†ì´ ì†ì„ ë‚´ë°€ì—ˆë‹¤. ë”°ëœ»í•˜ê³  ë‹¨ë‹¨í•œ ì†ì´ì—ˆë‹¤.' },
      { t:10, h:7,  txt:'"ìœ„í—˜í•œ ê³³ì—” í˜¼ì ê°€ì§€ ë§ˆì‹­ì‹œì˜¤." í‰ì†Œë³´ë‹¤ ë‚®ê³  ì§„ì§€í•œ ëª©ì†Œë¦¬ì˜€ë‹¤.',
        choices:['ê³ ë§™ë‹¤ê³  ë§í•œë‹¤','ì™œ ì‹ ê²½ ì“°ëƒê³  ë¬»ëŠ”ë‹¤','ì•ìœ¼ë¡œë„ ì§€ì¼œë‹¬ë¼ê³  í•œë‹¤'],
        res:[
          {h:4,txt:'ì¹´ì‹œì•ˆì´ ì§§ê²Œ ê³ ê°œë¥¼ ë„ë•ì˜€ë‹¤. ê·¸ ëˆˆë¹›ì´ ì˜¤ë˜ ë‚¨ì•˜ë‹¤.'},
          {h:6,txt:'"â€¦ì„ë¬´ì…ë‹ˆë‹¤." ê·¸ëŸ¬ë‚˜ ì‹œì„ ì´ ì ê¹ í”ë“¤ë ¸ë‹¤.'},
          {h:8,txt:'ì¹´ì‹œì•ˆì´ ë©ˆì¶”ë”ë‹ˆ ì²œì²œíˆ ë§í–ˆë‹¤. "â€¦ê·¸ë¦¬í•˜ê² ìŠµë‹ˆë‹¤."'}
        ]},
      { t:20, h:10, txt:'ì„ë¬´ ì¤‘ ë¶€ìƒì„ ì…ì€ ì¹´ì‹œì•ˆ. ì§ì ‘ ì¹˜ë£Œí•´ì£¼ì "ê³ ë§™ìŠµë‹ˆë‹¤"ë¼ëŠ” ë§ì´ ê·“ê°€ì— ë§´ëŒì•˜ë‹¤.' },
      { t:30, h:16, txt:'í­í’ìš° ì¹˜ëŠ” ë°¤, ì¹´ì‹œì•ˆì´ ì°½ë¬¸ ì•ì— ì„œ ìˆì—ˆë‹¤. "â€¦ê±±ì •ì´ ëìŠµë‹ˆë‹¤." ê·¸ê²ƒë¿ì´ì—ˆë‹¤.' }
    ]},

  { id:'saren',   icon:'ğŸŒŠ', name:'ì‚¬ë Œ',    title:'ì´ë°©ì¸ ìƒì¸',      color:'#40c0e8',
    desc:'ë¨¼ ë‚˜ë¼ì—ì„œ ì˜¨ ì´êµ­ì  ì²­ë…„. ììœ ë¶„ë°©í•˜ì§€ë§Œ ì •ì²´ë¥¼ ìˆ¨ê¸°ê³  ìˆë‹¤.',
    meet: t => t >= 5,
    events: [
      { t:6,  h:5,  txt:'ì‹œì¥ì—ì„œ ë‚¯ì„  ì²­ë…„ì´ í¬ê·€ ë§ˆë²• ì¬ë£Œë¥¼ ê±´ë„¸ë‹¤. "ê³µì§œì•¼. ì¸ì—°ì´ ë‹¿ì„ ê²ƒ ê°™ì•„ì„œ."' },
      { t:14, h:8,  txt:'ì‚¬ë Œì´ ë¨¼ ë‚˜ë¼ì˜ ì´ì•¼ê¸°ë¥¼ ë“¤ë ¤ì¤¬ë‹¤. ê·¸ì˜ ëˆˆë¹›ì— ê¹Šì€ ë¬´ì–¸ê°€ê°€ ìˆ¨ì–´ ìˆì—ˆë‹¤.',
        choices:['ê³ í–¥ì´ ê·¸ë¦½ëƒê³  ë¬»ëŠ”ë‹¤','ì •ì²´ê°€ ë­ëƒê³  ë¬»ëŠ”ë‹¤','ì¡°ìš©íˆ ì´ì•¼ê¸°ë¥¼ ë“£ëŠ”ë‹¤'],
        res:[
          {h:6,txt:'ì‚¬ë Œì´ ì ê¹ êµ³ì—ˆë‹¤ê°€ ì›ƒì—ˆë‹¤. "â€¦ë§ì•„. ê·¸ë¦¬ì›Œ."'},
          {h:4,txt:'"ì–¸ì  ê°€ ì•Œê²Œ ë  ê±°ì•¼." ê·¸ê°€ ëŠ¥ì²­ìŠ¤ëŸ½ê²Œ í”¼í–ˆë‹¤.'},
          {h:8,txt:'ë§ ì—†ì´ ë“¤ì–´ì£¼ì ì‚¬ë Œì´ ë” ë§ì€ ì´ì•¼ê¸°ë¥¼ í„¸ì–´ë†“ê¸° ì‹œì‘í–ˆë‹¤.'}
        ]},
      { t:24, h:12, txt:'"ë‚˜ë¥¼ ë¯¿ì–´ë„ ë¼." ì‚¬ë Œì˜ ì •ì²´ê°€ ì¡°ê¸ˆì”© ë“œëŸ¬ë‚˜ê¸° ì‹œì‘í–ˆë‹¤. ë‹¹ì‹ ë§Œì´ ì•„ëŠ” ë¹„ë°€.' },
      { t:34, h:18, txt:'"ê°™ì´ ê°€ì. ì´ ì™•êµ­ ë„ˆë¨¸ë¡œ." ê·¸ê°€ ì†ì„ ë‚´ë°€ì—ˆë‹¤. ì§€ë„ì— ì—†ëŠ” ë•…ìœ¼ë¡œ.' }
    ]},

  { id:'vain',    icon:'ğŸŒ‘', name:'ë² ì¸',    title:'ê¸ˆì§€ëœ ë§ˆë²•ì‚¬',    color:'#9050e0',
    desc:'ì•„ì¹´ë°ë¯¸ì—ì„œ ì¶”ë°©ëœ ì²œì¬. ëƒ‰ë‹´í•˜ì§€ë§Œ ì£¼ì¸ê³µì—ê²Œë§Œ ë‹¤ë¥´ê²Œ ë°˜ì‘í•œë‹¤.',
    meet: t => t >= 7,
    events: [
      { t:8,  h:4,  txt:'ê¸ˆì§€ëœ ë„ì„œê´€ì—ì„œ ê²€ì€ ë§í† ì˜ ì²­ë…„ê³¼ ë§ˆì£¼ì³¤ë‹¤. "ì™œ ì´ê³³ì—?" ì°¨ê°‘ê³  ë‚ ì¹´ë¡œìš´ ëˆˆë¹›.' },
      { t:16, h:7,  txt:'"ë„Œ ë‹¤ë¥´êµ°." ë² ì¸ì´ ì²˜ìŒìœ¼ë¡œ ì…ì„ ì—´ì—ˆë‹¤. ê·¸ í•œ ë§ˆë””ê°€ ì´ìƒí•˜ê²Œ ì‹¬ì¥ì— ë°•í˜”ë‹¤.',
        choices:['ì–´ë–»ê²Œ ë‹¤ë¥´ëƒê³  ë¬»ëŠ”ë‹¤','íƒœì—°íˆ ìˆëŠ”ë‹¤','ë¬´ì—‡ì„ ì—°êµ¬í•˜ëƒê³  ë¬»ëŠ”ë‹¤'],
        res:[
          {h:5,txt:'"â€¦ì„¤ëª…í•˜ê¸° ì–´ë µë‹¤." ë² ì¸ì´ ëˆˆì„ í”¼í–ˆë‹¤.'},
          {h:8,txt:'ë² ì¸ì´ í¥ë¯¸ë¡­ë‹¤ëŠ” ë“¯ ë‹¹ì‹ ì„ ë°”ë¼ë´¤ë‹¤.'},
          {h:6,txt:'"ê¸ˆì§€ëœ ê²ƒë“¤." ì°¨ê°‘ê²Œ ë§í–ˆì§€ë§Œ ë§ì„ ì´ì–´ë‚˜ê°”ë‹¤.'}
        ]},
      { t:26, h:14, txt:'ê¸ˆì§€ëœ ë§ˆë²•ì˜ ìœ„í—˜ì— ì²˜í–ˆì„ ë•Œ ë² ì¸ì´ ë‚˜íƒ€ë‚¬ë‹¤. ìƒì²˜ë¥¼ ì…ì€ ì±„ë¡œ. "â€¦ë‹¤ì¹˜ë©´ ì•ˆ ë¼."' },
      { t:35, h:22, txt:'"ë‚˜ì™€ í•¨ê»˜ë¼ë©´ ì„¸ìƒì´ ë‘ë µì§€ ì•Šë‹¤." ì–´ë‘  ì†ì—ì„œ ë‹¹ì‹ ë§Œì´ ê·¸ì˜ ë¹›ì´ì—ˆë‹¤.' }
    ]},

  { id:'elias',   icon:'ğŸ‘¨â€ğŸª', name:'ì—˜ë¦¬ì•„ìŠ¤',title:'ë§ˆì„ ì•½ì œì‚¬',      color:'#50d080',
    desc:'ì˜¨í™”í•˜ê³  ë‹¤ì •í•œ ì²­ë…„ ì•½ì œì‚¬. í™”ë ¤í•˜ì§€ ì•Šì§€ë§Œ í•­ìƒ ê³ì— ìˆì–´ì¤€ë‹¤.',
    meet: t => t >= 1,
    events: [
      { t:2,  h:4,  txt:'ì•½ì œì‚¬ ê°€ê²Œì—ì„œ ì²˜ìŒ ë§Œë‚¬ë‹¤. ì—˜ë¦¬ì•„ìŠ¤ê°€ ë¯¸ì†Œ ì§€ìœ¼ë©° ì•½ì´ˆë¥¼ ë¤ìœ¼ë¡œ ì±™ê²¨ì¤¬ë‹¤.' },
      { t:9,  h:6,  txt:'"ë¬´ë¦¬í•˜ì§€ ë§ˆì„¸ìš”." í”¼ë¡œ íšŒë³µì œë¥¼ ì¡°ìš©íˆ ê±´ë„¸ë‹¤. ëˆˆì´ ë§ˆì£¼ì³¤ë‹¤.',
        choices:['ê³ ë§ˆì›Œí•˜ë©° ë°›ëŠ”ë‹¤','ê´œì°®ë‹¤ê³  ì‚¬ì–‘í•œë‹¤','ì™œ ì‹ ê²½ ì“°ëƒê³  ë¬»ëŠ”ë‹¤'],
        res:[
          {h:5,txt:'ì—˜ë¦¬ì•„ìŠ¤ê°€ í™˜í•˜ê²Œ ì›ƒì—ˆë‹¤. "ì–¸ì œë“  ì˜¤ì„¸ìš”."'},
          {h:2,txt:'ì—˜ë¦¬ì•„ìŠ¤ê°€ ìˆ˜ì¤ê²Œ ë‚´ë ¤ë†“ê³  ê°”ë‹¤. "â€¦ê·¸ëƒ¥ ë‘ê³  ê°ˆê²Œìš”."'},
          {h:6,txt:'"ê·¸ëƒ¥â€¦ ì¢‹ì€ ë§ˆë²•ì‚¬ê°€ ëìœ¼ë©´ í•´ì„œìš”." ê·¸ê°€ ìˆ˜ì¤ê²Œ ë§í–ˆë‹¤.'}
        ]},
      { t:18, h:10, txt:'ë¹„ ì˜¤ëŠ” ë‚  ê°€ê²Œ ì•ì—ì„œ ê¸°ë‹¤ë¦¬ë‹¤ê°€ ë“¤ì¼°ë‹¤. ì—˜ë¦¬ì•„ìŠ¤ê°€ ìš°ì‚°ì„ ë‚´ë°€ì—ˆë‹¤.' },
      { t:28, h:16, txt:'"ìˆ˜ë ¨ì´ ëë‚˜ë„ ê°€ê²ŒëŠ” ì—¬ê¸° ìˆì„ í…Œë‹ˆê¹Œìš”." ê·¸ ë§ì— ë‹´ê¸´ ì˜ë¯¸ë¥¼ ë‹¹ì‹ ì€ ì•Œì•˜ë‹¤.' }
    ]},

  { id:'jaiden',  icon:'âš”ï¸', name:'ì œì´ë“ ',  title:'ë¼ì´ë²Œ ìˆ˜ë ¨ìƒ',    color:'#ff6060',
    desc:'ê²‰ìœ¼ë¡œëŠ” ë„ë°œí•˜ì§€ë§Œ ì‚¬ì‹¤ ê°€ì¥ ì‹ ê²½ ì¨ì£¼ëŠ” ë™ê°‘ ì¸¤ë°ë ˆ.',
    meet: t => t >= 1,
    events: [
      { t:2,  h:3,  txt:'"í¥, ì´ ì •ë„ ë§ˆë²•ì€ ë‚˜ë„ í•´." ì½”ì›ƒìŒì³¤ì§€ë§Œ ì€ê·¼íˆ ê°™ì€ ì‹¤ìˆ˜ë¥¼ ì•Œë ¤ì¤¬ë‹¤.' },
      { t:11, h:6,  txt:'ì–´ë ¤ìš´ ì‹œí—˜ì—ì„œ ì œì´ë“ ì´ íŒíŠ¸ë¥¼ ì¤¬ë‹¤. "â€¦ë°©í•´ë°›ê¸° ì‹«ì–´ì„œì•¼. ì°©ê°í•˜ì§€ ë§ˆ."',
        choices:['ê³ ë§™ë‹¤ê³  ì†”ì§í•˜ê²Œ ë§í•œë‹¤','ëª¨ë¥¸ ì²™ ë„˜ì–´ê°„ë‹¤','ëŒ€ì‹  ë„ì™€ì£¼ê² ë‹¤ê³  í•œë‹¤'],
        res:[
          {h:3,txt:'ì œì´ë“ ì´ ì–¼êµ´ì„ ë¶‰íˆë©° ê³ ê°œë¥¼ ëŒë ¸ë‹¤. "ëì–´."'},
          {h:5,txt:'ì™ ì§€ ì œì´ë“ ì´ ë” ê°€ê¹Œì´ ì˜¤ëŠ” ê²ƒ ê°™ì•˜ë‹¤.'},
          {h:7,txt:'"â€¦í•„ìš” ì—†ê±°ë“ !" í•˜ì§€ë§Œ ìŠ¬ê·¸ë¨¸ë‹ˆ ì˜†ì— ì•‰ì•˜ë‹¤.'}
        ]},
      { t:21, h:10, txt:'ì¶•ì œì—ì„œ í˜¼ì ìˆëŠ” ê±¸ ë°œê²¬í•œ ì œì´ë“ . "â€¦í˜¼ì ìˆìœ¼ë©´ ê·€ì‹  ë‚˜ì˜¨ë‹¤ê³ . ê°™ì´ ë‹¤ë…€."' },
      { t:33, h:18, txt:'"ë¼ì´ë²Œì´ ì´ëŸ° ë§ í•˜ê¸´ ì¢€ ê·¸ëŸ°ë°â€¦ ë„ˆ ì—†ìœ¼ë©´ ì¬ë¯¸ì—†ì–ì•„." ë³¼ì´ ë¹¨ê°›ê²Œ ë‹¬ì•„ì˜¬ëë‹¤.' }
    ]},

  { id:'oliver',  icon:'ğŸ¤', name:'ì˜¬ë¦¬ë²„',  title:'ì ˆì¹œí•œ ì¹œêµ¬',      color:'#90c0f0',
    desc:'ì°¨ë¶„í•˜ê³  í˜„ì‹¤ì ì¸ ì¡°ì–¸ì. ë…¼ë¦¬ë¥¼ ì•ì„¸ìš°ì§€ë§Œ ë‹¹ì‹ ì„ ìœ„í•´ì„œëŠ” ë‹¬ë¼ì§„ë‹¤.',
    meet: t => t >= 1,
    events: [
      { t:3,  h:3,  txt:'"ì´ ë°©ë²•ì€ ë¹„íš¨ìœ¨ì ì´ì•¼. ì´ë ‡ê²Œ í•´ë´." ì°¨ë¶„íˆ ì„¤ëª…í•´ì¤¬ë‹¤. ê³ ë§ˆì› ë‹¤.' },
      { t:13, h:6,  txt:'"ê±±ì •í•˜ì§€ ë§ˆ. ë°ì´í„°ìƒìœ¼ë¡œ ë„¤ê°€ ì¶©ë¶„íˆ í•  ìˆ˜ ìˆì–´." ì´ìƒí•˜ê²Œ ë”°ëœ»í•œ ë§ì´ì—ˆë‹¤.',
        choices:['ê³ ë§™ë‹¤ê³  ë§í•œë‹¤','ë„ˆë„ í˜ë“¤ì§€ ì•Šëƒê³  ë¬»ëŠ”ë‹¤','ê°™ì´ ê³µë¶€í•˜ìê³  ì œì•ˆí•œë‹¤'],
        res:[
          {h:4,txt:'ì˜¬ë¦¬ë²„ê°€ ëˆˆì„ ì‚´ì§ ë‚´ë¦¬ê¹”ì•˜ë‹¤. "â€¦ë‹¹ì—°í•œ ë§ì´ì•¼."'},
          {h:6,txt:'"â€¦ê°€ë”ì€. í•˜ì§€ë§Œ ë„¤ê°€ ìˆìœ¼ë©´ ëœí•´." ì˜¬ë¦¬ë²„ê°€ ë“œë¬¼ê²Œ ì†”ì§í–ˆë‹¤.'},
          {h:7,txt:'"íš¨ìœ¨ì´ ì˜¤ë¥¼ ê²ƒ ê°™êµ°." ê·¸ëŸ¬ë‚˜ ì‹¤ì œë¡  3ì‹œê°„ì„ ê°™ì´ ì•‰ì•„ ìˆì—ˆë‹¤.'}
        ]},
      { t:23, h:10, txt:'ì˜¬ë¦¬ë²„ê°€ ì²˜ìŒìœ¼ë¡œ ê³„íš ì—†ì´ ë‹¹ì‹  ê³ì— ìˆì—ˆë‹¤. "â€¦ê°€ë”ì€ ì´ëŸ° ê²ƒë„ ë‚˜ì˜ì§€ ì•Šë„¤."' },
      { t:34, h:16, txt:'"ë…¼ë¦¬ì ìœ¼ë¡œ ë”°ì ¸ë´¤ëŠ”ë°, ë‚´ê°€ ë„ˆë¥¼ ì¢‹ì•„í•˜ëŠ” ê²ƒ ê°™ì•„." ì˜¬ë¦¬ë²„ê°€ ëˆˆì„ í”¼í–ˆë‹¤.' }
    ]},
];

/* í™œë™: ì•„ë¥´ë°”ì´íŠ¸ / ìˆ˜ì—… / ì‚¬êµ / ë¬´ë£Œ */
const ACTS = [
  /* JOB */
  { id:'apothecary_job', type:'job', unlock:1, icon:'ğŸ§ª', name:'ì•½ë°© ë³´ì¡°', stat:{know:1}, fat:10, gold:14, npc:'elias', nc:.28, fail:.06, fstat:{gold:-4}, ftxt:'ì•½ì´ˆ ì¬ê³ ë¥¼ í—·ê°ˆë ¸ë‹¤. ë³´ìˆ˜ -4G' },
  { id:'market_delivery', type:'job', unlock:1, icon:'ğŸ“¦', name:'ì‹œì¥ ë°°ë‹¬', stat:{body:1}, fat:14, gold:16, npc:'saren', nc:.22, fail:.10, fstat:{fat:8}, ftxt:'ì§ì„ ë–¨ì–´ëœ¨ë ¤ ì¶”ê°€ ë…¸ë™! í”¼ë¡œ +8' },
  { id:'library_sorting', type:'job', unlock:1, icon:'ğŸ—‚ï¸', name:'ì„œê³  ì •ë¦¬', stat:{know:1}, fat:8, gold:12, npc:'oliver', nc:.24, fail:.05, fstat:{gold:-3}, ftxt:'ê³ ì„œë¥¼ ì˜ëª» ë¶„ë¥˜í–ˆë‹¤. ë³´ìˆ˜ -3G' },
  { id:'alchemy_assist', type:'job', unlock:1, icon:'âš—ï¸', name:'ì—°ê¸ˆ ì¡°ìˆ˜', stat:{mana:1}, fat:12, gold:15, npc:'vain', nc:.14, fail:.14, fstat:{gold:-5,mana:-1}, ftxt:'ì—°ê¸ˆ ë°˜ì‘ì´ í­ì£¼í–ˆë‹¤. ë³´ìˆ˜ -5G, ë§ˆë ¥ -1' },
  { id:'wall_guard', type:'job', unlock:2, icon:'ğŸ›¡ï¸', name:'ì„±ë²½ ê²½ë¹„', stat:{body:1}, fat:16, gold:17, npc:'cassian', nc:.26, fail:.10, fstat:{fat:10}, ftxt:'ì•¼ê°„ ê·¼ë¬´ ì—°ì¥! í”¼ë¡œ +10' },
  { id:'banquet_service', type:'job', unlock:2, icon:'ğŸ·', name:'ì—°íšŒì¥ ì„œë¹™', stat:{social:1}, fat:12, gold:13, npc:'leon', nc:.30, fail:.08, fstat:{social:-1}, ftxt:'ì”ì„ ìŸì•„ ë¯¼ë§í•œ ì‹¤ìˆ˜. ì‚¬êµ -1' },

  /* CLASS */
  { id:'elemental_class', type:'class', unlock:1, icon:'âœ¨', name:'ê¸°ì´ˆ ì›ì†Œ ë§ˆë²•', stat:{mana:2}, fat:10, gold:-10, npc:'vain', nc:.14, fail:.10, fstat:{mana:-1}, ftxt:'ì§‘ì¤‘ì´ ííŠ¸ëŸ¬ì¡Œë‹¤. ë§ˆë ¥ -1' },
  { id:'ancient_texts', type:'class', unlock:1, icon:'ğŸ“š', name:'ê³ ëŒ€ ë¬¸í—Œí•™', stat:{know:2}, fat:8, gold:-10, npc:'oliver', nc:.18, fail:.06, fstat:{know:-1}, ftxt:'ë‚œí•´í•œ ë¬¸ì¥ì„ ì˜ëª» í•´ì„í–ˆë‹¤. ì§€ì‹ -1' },
  { id:'alchemy_practicum', type:'class', unlock:1, icon:'ğŸ”¬', name:'ì—°ê¸ˆìˆ  ì‹¤ìŠµ', stat:{mana:1,know:1}, fat:11, gold:-15, npc:'elias', nc:.14, fail:.12, fstat:{gold:-5}, ftxt:'ì¬ë£Œë¥¼ ë‹¤ì‹œ êµ¬ë§¤í–ˆë‹¤. ì¶”ê°€ ë¹„ìš© -5G' },
  { id:'martial_basics', type:'class', unlock:1, icon:'ğŸ’ª', name:'ì²´ìˆ  ê¸°ì´ˆ', stat:{body:2}, fat:14, gold:-8, npc:'cassian', nc:.18, fail:.12, fstat:{fat:8}, ftxt:'í›ˆë ¨ì´ ê¸¸ì–´ì¡Œë‹¤. í”¼ë¡œ +8' },
  { id:'court_etiquette', type:'class', unlock:2, icon:'ğŸ‘‘', name:'ê¶ì • ì˜ˆë²•', stat:{social:2}, fat:8, gold:-12, npc:'leon', nc:.22, fail:.08, fstat:{social:-1}, ftxt:'ì˜ˆë²•ì„ í‹€ë ¸ë‹¤. ì‚¬êµ -1' },
  { id:'forbidden_decoding', type:'class', unlock:3, icon:'ğŸŒ‘', name:'ê¸ˆì„œ í•´ë…', stat:{mana:2,know:1}, fat:14, gold:-18, npc:'vain', nc:.30, fail:.16, fstat:{mana:-2,fat:10}, ftxt:'ê¸ˆì„œì˜ ë°˜ì‘ìš©ì„ ë°›ì•˜ë‹¤. ë§ˆë ¥ -2, í”¼ë¡œ +10', forbidden:true },

  /* SOCIAL */
  { id:'royal_tea', type:'social', unlock:1, icon:'ğŸ«–', name:'ì™•ê¶ í‹°íŒŒí‹°', stat:{social:1}, fat:8, gold:-16, npc:'leon', nc:.35, fail:.06, fstat:{social:-1}, ftxt:'ëŒ€í™”ê°€ ì–´ìƒ‰í•˜ê²Œ ê¼¬ì˜€ë‹¤. ì‚¬êµ -1' },
  { id:'night_market', type:'social', unlock:1, icon:'ğŸ®', name:'ì•¼ì‹œì¥ ì‚°ì±…', stat:{social:1}, fat:5, gold:-8, npc:'saren', nc:.34, fail:.06, fstat:{gold:-5}, ftxt:'ì¶©ë™êµ¬ë§¤ê°€ ëŠ˜ì–´ë‚¬ë‹¤. ì¶”ê°€ ì§€ì¶œ -5G' },
  { id:'herb_tea_circle', type:'social', unlock:1, icon:'ğŸŒ¿', name:'ì•½ì´ˆì°¨ ëª¨ì„', stat:{social:1}, fat:-5, gold:-9, npc:'elias', nc:.30, fail:.03, fstat:{}, ftxt:'ì¡°ìš©í•œ ì‹œê°„ë§Œ í˜ë €ë‹¤.' },
  { id:'knight_stands', type:'social', unlock:2, icon:'ğŸ‡', name:'ê¸°ì‚¬ë‹¨ ê´€ëŒ', stat:{social:1,body:1}, fat:7, gold:-10, npc:'cassian', nc:.28, fail:.06, fstat:{fat:5}, ftxt:'ì˜ˆìƒë³´ë‹¤ ì˜¤ë˜ ì„œ ìˆì—ˆë‹¤. í”¼ë¡œ +5' },
  { id:'festival', type:'social', unlock:2, icon:'ğŸ‰', name:'ì™•êµ­ ì¶•ì œ', stat:{social:2}, fat:12, gold:-18, npc:'jaiden', nc:.26, fail:.10, fstat:{gold:-7}, ftxt:'ì¶•ì œì—ì„œ ëˆì„ ë” ì¨ë²„ë ¸ë‹¤. ì¶”ê°€ ì§€ì¶œ -7G' },
  { id:'secret_archive', type:'social', unlock:3, icon:'ğŸ•¯ï¸', name:'ë¹„ë°€ ì„œê³  íƒë°©', stat:{know:1}, fat:9, gold:-12, npc:'vain', nc:.36, fail:.12, fstat:{fat:8}, ftxt:'ìˆ˜ìƒí•œ ê¸°ìš´ì— ì˜¤ë˜ ë¨¸ë¬¼ë €ë‹¤. í”¼ë¡œ +8', forbidden:true },

  /* FREE */
  { id:'self_practice', type:'free', unlock:1, icon:'ğŸ”®', name:'ììœ¨ ì—°ìŠµ', stat:{mana:1}, fat:8, gold:0, npc:null, nc:0, fail:.08, fstat:{mana:-1}, ftxt:'ë§ˆë²•ì‹ì´ ê¼¬ì˜€ë‹¤. ë§ˆë ¥ -1' },
  { id:'note_review', type:'free', unlock:1, icon:'ğŸ“', name:'ë³µìŠµ ì •ë¦¬', stat:{know:1}, fat:6, gold:0, npc:null, nc:0, fail:.05, fstat:{}, ftxt:'ìƒê°ë³´ë‹¤ ì •ë¦¬ê°€ ì˜ ì•ˆ ëë‹¤.' },
  { id:'walk', type:'free', unlock:1, icon:'ğŸš¶', name:'ì‚°ì±…', stat:{social:1}, fat:-5, gold:0, npc:'saren', nc:.12, fail:0, fstat:{}, ftxt:'' },
  { id:'nap', type:'free', unlock:1, icon:'ğŸ˜´', name:'ë‚®ì ', stat:{}, fat:-20, gold:0, npc:null, nc:0, fail:0, fstat:{}, ftxt:'' },
  { id:'meditate', type:'free', unlock:2, icon:'ğŸ§˜', name:'ëª…ìƒ', stat:{mana:1}, fat:-8, gold:0, npc:null, nc:0, fail:.03, fstat:{}, ftxt:'ì¡ë…ì´ ë§ì•˜ë‹¤.' }
];

const SHOP = [
  { id:'pot',  name:'ğŸ§ª í”¼ë¡œ íšŒë³µì œ',  cost:38, eff:{fat:-35},  desc:'í”¼ë¡œ âˆ’35' },
  { id:'book', name:'ğŸ“– ë§ˆë²• ì£¼ì„ì„œ',  cost:58, eff:{know:3},   desc:'ì§€ì‹ +3' },
  { id:'crys', name:'ğŸ’ ë§ˆë ¥ ìˆ˜ì •',    cost:72, eff:{mana:4},   desc:'ë§ˆë ¥ +4' },
  { id:'herb', name:'ğŸŒº ê³ ê¸‰ ì•½ì´ˆ',    cost:48, eff:{body:3},   desc:'ì²´ë ¥ +3' },
  { id:'chrm', name:'ğŸ’Œ í–‰ìš´ ë¶€ì ',    cost:85, eff:{social:4}, desc:'ì‚¬êµ +4' },
];

const RANDS = [
  { ico:'â›ˆï¸', ttl:'í­í’ìš°',      txt:'í­í’ìš°ë¡œ ì•¼ê°„ ìˆ˜ë ¨ì´ ì™„ì „íˆ ê¼¬ì˜€ë‹¤.',              eff:{mana:-2,fat:8},             tags:['ë§ˆë ¥ âˆ’2','í”¼ë¡œ +8'] },
  { ico:'ğŸŒŸ', ttl:'ë§ˆë²• ê°ì„±',   txt:'ìˆ˜ë ¨ ì¤‘ ê°‘ìê¸° ë§ˆë ¥ì´ ì†Ÿêµ¬ì³¤ë‹¤!',                  eff:{mana:3},                    tags:['ë§ˆë ¥ +3'] },
  { ico:'ğŸ“œ', ttl:'ê³ ì„œ ë°œê²¬',   txt:'ë¨¼ì§€ ìŒ“ì¸ ì„œê³ ì—ì„œ ê·€í•œ ë§ˆë²• ê³ ì„œë¥¼ ë°œê²¬í–ˆë‹¤.',    eff:{know:3},                    tags:['ì§€ì‹ +3'] },
  { ico:'ğŸ‰', ttl:'ë“œë˜ê³¤ ì†Œë™', txt:'ì™•êµ­ ì™¸ê³½ ì†Œë™ìœ¼ë¡œ ì˜ˆì •ì´ ê¼¬ì˜€ë‹¤.',                 eff:{fat:18},                    tags:['í”¼ë¡œ +18'] },
  { ico:'ğŸ€', ttl:'í–‰ìš´ì˜ ë‚ ',   txt:'ì˜¤ëŠ˜ì€ ì´ìƒí•˜ê²Œ ëª¨ë“  ê²Œ ì˜ í’€ë¦°ë‹¤.',                eff:{mana:1,know:1,body:1,social:1}, tags:['ì „ ìŠ¤íƒ¯ +1'] },
  { ico:'ğŸ’¸', ttl:'ì„¸ê¸ˆ ì§•ìˆ˜',   txt:'ì˜ˆìƒì¹˜ ëª»í•œ ì™•ì‹¤ ì„¸ê¸ˆì´ ë¶€ê³¼ëë‹¤.',                 eff:{gold:-25},                  tags:['ê³¨ë“œ âˆ’25G'] },
  { ico:'ğŸŒ¸', ttl:'ì™•êµ­ ì¶•ì œ',   txt:'ì ì‹œ ìˆ˜ë ¨ì„ ìŠê³  ì¶•ì œë¥¼ ì¦ê²¼ë‹¤.',                   eff:{social:2,fat:-8},           tags:['ì‚¬êµ +2','í”¼ë¡œ âˆ’8'] },
  { ico:'ğŸŒ¡ï¸', ttl:'ë³‘ì¹˜ë ˆ',      txt:'ëª¸ ìƒíƒœê°€ ì¢‹ì§€ ì•Šì•„ íšŒë³µì— ì‹œê°„ì„ ì¼ë‹¤.',            eff:{body:-2,fat:20,gold:-12},   tags:['ì²´ë ¥ âˆ’2','í”¼ë¡œ +20','ê³¨ë“œ âˆ’12G'] },
  { ico:'ğŸ–ï¸', ttl:'ì¹­ì°¬ì¥',      txt:'ì´ë²ˆ ë‹¬ ì„±ì‹¤í•¨ì„ ì¸ì •ë°›ì•„ í¬ìƒê¸ˆì„ ë°›ì•˜ë‹¤.',         eff:{gold:20,know:1},            tags:['ê³¨ë“œ +20G','ì§€ì‹ +1'] },
];

const DATE_EVS = {
  leon:[
    { req:30, fat:10, h:8,  txt:'ë ˆì˜¨ê³¼ ì™•ê¶ ì •ì›ì„ ì‚°ì±…í–ˆë‹¤. ê·¸ê°€ ê½ƒì„ êº¾ì–´ì¤¬ë‹¤.',
      choices:['ê³ ë§ˆì›Œí•˜ë©° ë°›ëŠ”ë‹¤','ê°™ì´ í•˜ë‚˜ ë” êº¾ëŠ”ë‹¤'],
      res:[{h:4,txt:'"ì˜ˆì˜ë‹¤." ë ˆì˜¨ì´ ë‹¹ì‹ ì„ ë³´ë©° ë§í–ˆë‹¤.'},{h:6,txt:'ë ˆì˜¨ì´ ì›ƒìœ¼ë©° ë¨¸ë¦¬ì— ê½‚ì•„ì¤¬ë‹¤.'}]},
    { req:60, fat:15, h:12, txt:'ë ˆì˜¨ì´ ì™•ì‹¤ ìŒì•…íšŒì— ì´ˆëŒ€í–ˆë‹¤. í™”ë ¤í•œ ì•¼ê²½ ì•„ë˜ ë‘˜ë§Œì˜ ì‹œê°„.',
      choices:['ì†ì„ ë¨¼ì € ì¡ëŠ”ë‹¤','ê·¸ëƒ¥ ê³ì— ìˆëŠ”ë‹¤'],
      res:[{h:8,txt:'ë ˆì˜¨ì´ êµ³ì–´ìˆë‹¤ê°€ ì†ì„ ê¼­ ì¥ì—ˆë‹¤.'},{h:5,txt:'ë ˆì˜¨ì´ ì¡°ìš©íˆ ì–´ê¹¨ë¥¼ ê¸°ëŒ”ë‹¤.'}]},
  ],
  cassian:[
    { req:30, fat:15, h:7, txt:'ì¹´ì‹œì•ˆì´ ê²€ìˆ  í›ˆë ¨ì„ ë´ì£¼ê² ë‹¤ê³  í–ˆë‹¤. ë“œë¬¸ ì¼ì´ì—ˆë‹¤.',
      choices:['ì—´ì‹¬íˆ ë°°ìš´ë‹¤','ëª»í•˜ëŠ” ì²™ í•‘ê³„ë¥¼ ëŒ„ë‹¤'],
      res:[{h:4,txt:'ì¹´ì‹œì•ˆì´ ì§„ì§€í•˜ê²Œ ìì„¸ë¥¼ ê³ ì³ì¤¬ë‹¤.'},{h:6,txt:'"â€¦ì œê°€ ì¡ì•„ë“œë¦´ê²Œìš”." ì¹´ì‹œì•ˆì´ ë’¤ì—ì„œ ìì„¸ë¥¼ ì¡ì•„ì¤¬ë‹¤.'}]},
    { req:60, fat:10, h:12, txt:'ë‹¬ë¹› ì•„ë˜ ì„±ë²½ì„ ê±·ë‹¤ ì¹´ì‹œì•ˆì´ ë©ˆì·„ë‹¤. "ì•„ë¦„ë‹µêµ°ìš”." ê·¸ ë§ì´ ë‹¹ì‹ ì„ í–¥í•œ ê²ƒ ê°™ì•˜ë‹¤.' },
  ],
  saren:[
    { req:30, fat:8, h:7, txt:'ì‚¬ë Œì´ ì´êµ­ì ì¸ ìš”ë¦¬ë¥¼ ë§Œë“¤ì–´ì¤¬ë‹¤. ì²˜ìŒ ë¨¹ì–´ë³´ëŠ” ë‚¯ì„  ë§›.',
      choices:['ë§›ìˆë‹¤ê³  ì†”ì§íˆ ë§í•œë‹¤','ì–´ëŠ ë‚˜ë¼ ìŒì‹ì´ëƒê³  ë¬»ëŠ”ë‹¤'],
      res:[{h:5,txt:'ì‚¬ë Œì´ í™œì§ ì›ƒì—ˆë‹¤. "ì—­ì‹œ ë„Œ ì •ì§í•´."'},{h:7,txt:'ì‚¬ë Œì´ ìì„¸íˆ ì´ì•¼ê¸°í•´ì¤¬ë‹¤. ê·¸ì˜ ê³ í–¥ì´ ì¡°ê¸ˆ ë³´ì˜€ë‹¤.'}]},
    { req:60, fat:8, h:13, txt:'ì‚¬ë Œì´ ì˜¥ìƒì—ì„œ ë³„ìë¦¬ë¥¼ ì•Œë ¤ì¤¬ë‹¤. "ì € ë³„ ì´ë¦„ì€â€¦ ìš°ë¦¬ ë‚˜ë¼ ë§ë¡œ \'ê·¸ë¦¬ì›€\'ì´ì•¼."' },
  ],
  vain:[
    { req:30, fat:10, h:8, txt:'ë² ì¸ì´ ê¸ˆì§€ëœ ì±…ì„ ë³´ì—¬ì¤¬ë‹¤. "ì´ ì •ë„ëŠ” ê´œì°®ì•„." ë‹¹ì‹ ë§Œì„ ìœ„í•œ ì˜ˆì™¸ì˜€ë‹¤.',
      choices:['í•¨ê»˜ ì½ëŠ”ë‹¤','ìœ„í—˜í•˜ì§€ ì•Šëƒê³  ë¬»ëŠ”ë‹¤'],
      res:[{h:6,txt:'ë² ì¸ì´ ë‚˜ë€íˆ ì•‰ì•„ ì„¤ëª…í•´ì¤¬ë‹¤. ê°€ê¹Œì› ë‹¤.'},{h:8,txt:'"ë„ˆë‘ ìˆìœ¼ë©´ ë‘ë µì§€ ì•Šì•„." ì²˜ìŒìœ¼ë¡œ ì†”ì§í•´ì¡Œë‹¤.'}]},
    { req:60, fat:12, h:16, txt:'"ë‚´ê°€ ì¶”ë°©ëœ ì§„ì§œ ì´ìœ â€¦ ë„ˆí•œí… ë§í• ê²Œ." ë² ì¸ì´ ì²˜ìŒìœ¼ë¡œ ë¹„ë°€ì„ í„¸ì–´ë†“ì•˜ë‹¤.' },
  ],
  elias:[
    { req:30, fat:8, h:7, txt:'ì—˜ë¦¬ì•„ìŠ¤ì˜ ê°€ê²Œì—ì„œ í•¨ê»˜ ì•½ì„ ë§Œë“¤ì—ˆë‹¤. ê·¸ê°€ ì†ì„ ê²¹ì³ ì¡ìœ¼ë©° ê°€ë¥´ì³ì¤¬ë‹¤.',
      choices:['ì‹¤ìˆ˜í•˜ëŠ” ì²™ í•œë‹¤','ì§„ì§€í•˜ê²Œ ë°°ìš´ë‹¤'],
      res:[{h:5,txt:'ì—˜ë¦¬ì•„ìŠ¤ê°€ ë¶€ë“œëŸ½ê²Œ ì¡ì•„ì¤¬ë‹¤. ì–¼êµ´ì´ ë¶‰ì–´ì¡Œë‹¤.'},{h:4,txt:'"ì˜ í•˜ì‹œëŠ”ê±¸ìš”." ì—˜ë¦¬ì•„ìŠ¤ê°€ ê¸°ì˜ê²Œ ì›ƒì—ˆë‹¤.'}]},
    { req:60, fat:5, h:14, txt:'"ì‚¬ì‹¤ ì˜¤ë˜ì „ë¶€í„° ê¸°ë‹¤ë ¸ì–´ìš”. ë‹¹ì‹ ì´ ì˜¤ëŠ” ë‚ ì„." ì—˜ë¦¬ì•„ìŠ¤ê°€ ì°¨ í•œ ì”ì„ ë‚´ë°€ë©° ë§í–ˆë‹¤.' },
  ],
  jaiden:[
    { req:30, fat:10, h:8, txt:'"ì•¼, ê°™ì´ ë°¥ì´ë‚˜ ë¨¹ì–´." í‰ëª…ìŠ¤ëŸ½ê²Œ ë§í–ˆì§€ë§Œ ì œì´ë“ ì´ ìŒì‹ì„ ì”ëœ© ì‹œì¼°ë‹¤.',
      choices:['"ê³ ë§ˆì›Œ"ë¼ê³  ë§í•œë‹¤','ë‹¹ì—°í•˜ë‹¤ëŠ” ë“¯ ë¨¹ëŠ”ë‹¤'],
      res:[{h:3,txt:'ì œì´ë“ ì´ ì–¼êµ´ì„ ë¶‰íˆë©° ê³ ê°œë¥¼ ëŒë ¸ë‹¤.'},{h:6,txt:'ì œì´ë“ ì´ í”¼ì‹ ì›ƒì—ˆë‹¤. "â€¦ê·¸ë˜, ë§ì´ ë¨¹ì–´."'}]},
    { req:60, fat:10, h:14, txt:'"ì§„ì§œ ì§œì¦ë‚˜ê±°ë“ , ë„¤ê°€. ì—†ìœ¼ë©´ í—ˆì „í•˜ê³ ." ì œì´ë“ ì´ í•˜ëŠ˜ì„ ì˜¬ë ¤ë‹¤ë´¤ë‹¤.' },
  ],
  oliver:[
    { req:30, fat:8, h:7, txt:'ì˜¬ë¦¬ë²„ê°€ ì²˜ìŒìœ¼ë¡œ ëª©ì  ì—†ì´ ê°™ì´ ê±·ìê³  í–ˆë‹¤. "ë¹„íš¨ìœ¨ì ì´ì§€ë§Œâ€¦ ê¸°ë¶„ì´ ë‚˜ì˜ì§€ ì•Šë„¤."',
      choices:['ì–´ìƒ‰í•˜ê²Œ ì›ƒëŠ”ë‹¤','ì´ëŸ° ê±° ì¢‹ë‹¤ê³  ë§í•œë‹¤'],
      res:[{h:4,txt:'ì˜¬ë¦¬ë²„ê°€ ì²œì²œíˆ ê±¸ìŒì„ ë§ì·„ë‹¤.'},{h:7,txt:'"â€¦ë‚˜ë„ ê·¸ë˜." ì˜¬ë¦¬ë²„ê°€ ì¡°ìš©íˆ ë§í–ˆë‹¤.'}]},
    { req:60, fat:8, h:14, txt:'"ê°ì •ì´ ë¹„íš¨ìœ¨ì ì´ë¼ê³  ë°°ì› ëŠ”ë°â€¦ ë„ˆ ì•ì—ì„œëŠ” ì•„ë‹Œ ê²ƒ ê°™ì•„." ì˜¬ë¦¬ë²„ê°€ ì²˜ìŒìœ¼ë¡œ ëˆˆì„ ë§ˆì£¼ì³¤ë‹¤.' },
  ],
};

const MAIN_ENDINGS = [
  {
    id:'legend', ico:'âœ¨', ttl:'ì „ì„¤ì˜ ëŒ€ë§ˆë²•ì‚¬',
    cond:s => s.mana >= 46 && s.know >= 46 && s.body >= 34 && s.social >= 34 && s.scholarship >= 2,
    txt:'ëª¨ë“  ë¶„ì•¼ì—ì„œ ì••ë„ì ì¸ ì„±ê³¼ë¥¼ ë‚¨ê¸´ ë‹¹ì‹ ì€ ì„¸ëŒ€ì— í•œ ë²ˆ ë‚˜ì˜¬ê¹Œ ë§ê¹Œ í•œ ì²œì¬ë¡œ ê¸°ë¡ë˜ì—ˆë‹¤. ìˆ˜ë°± ë…„ì´ ì§€ë‚˜ë„ ê·¸ ì´ë¦„ì€ ì „ì„¤ë¡œ ë‚¨ëŠ”ë‹¤.'
  },
  {
    id:'forbidden', ico:'ğŸŒ‘', ttl:'ê¸ˆì§€ëœ ë§ˆë„ì˜ ê³„ìŠ¹ì',
    cond:s => s.forbidden >= 4 && s.mana >= 34 && s.npc.vain >= 55,
    txt:'ë‹¹ì‹ ì€ ê¸ˆì§€ëœ ì§€ì‹ì˜ ë§¤ë ¥ì„ ëë‚´ ì™¸ë©´í•˜ì§€ ì•Šì•˜ë‹¤. ì‚¬ëŒë“¤ì€ ë‘ë ¤ì›Œí–ˆì§€ë§Œ, ë‹¹ì‹ ì€ ëˆ„êµ¬ë³´ë‹¤ ê¹Šì€ ì§„ì‹¤ì— ë‹¿ì•˜ë‹¤.'
  },
  {
    id:'archmage', ico:'ğŸ‘‘', ttl:'ì™•ì‹¤ ìˆ˜ì„ ë§ˆë²•ì‚¬',
    cond:s => s.mana >= 38 && s.know >= 38,
    txt:'3ë…„ì˜ ìˆ˜ë ¨ì„ ë§ˆì¹œ ë‹¹ì‹ ì€ ì™•êµ­ ì—­ì‚¬ìƒ ê°€ì¥ ì–´ë¦° ìˆ˜ì„ ë§ˆë²•ì‚¬ë¡œ ì„ëª…ë˜ì—ˆë‹¤. ì™•ì‹¤ì€ ë‹¹ì‹ ì˜ ì´ë¦„ì„ ê³µì‹ ê¸°ë¡ì— ë‚¨ê²¼ë‹¤.'
  },
  {
    id:'battle', ico:'âš”ï¸', ttl:'ì „íˆ¬ ë§ˆë„ì‚¬ë‹¨ ë‹¨ì¥',
    cond:s => s.mana >= 30 && s.body >= 34,
    txt:'ë§ˆë²•ê³¼ ì „íˆ¬ë¥¼ ê²¸ë¹„í•œ ë‹¹ì‹ ì€ ì™•êµ­ ìµœì •ì˜ˆ ì „íˆ¬ ë§ˆë„ì‚¬ë‹¨ì˜ ì§€íœ˜ë¥¼ ë§¡ì•˜ë‹¤. ì „ì¥ì—ì„œëŠ” ë‹¹ì‹ ì˜ ëª…ë ¹ í•˜ë‚˜ê°€ ìŠ¹ë¶€ë¥¼ ê°ˆëë‹¤.'
  },
  {
    id:'professor', ico:'ğŸ“', ttl:'ì•„ì¹´ë°ë¯¸ êµìˆ˜',
    cond:s => s.know >= 42 && s.classCount >= 18,
    txt:'ë‹¹ì‹ ì€ ì•„ì¹´ë°ë¯¸ì— ë‚¨ì•„ ì°¨ì„¸ëŒ€ ë§ˆë²•ì‚¬ë“¤ì„ ê°€ë¥´ì¹˜ê²Œ ë˜ì—ˆë‹¤. í•™ìƒë“¤ì€ ë‹¹ì‹ ì˜ ìˆ˜ì—…ì„ ë“£ê¸° ìœ„í•´ ê¸¸ê²Œ ì¤„ì„ ì„°ë‹¤.'
  },
  {
    id:'diplomat', ico:'ğŸ•Šï¸', ttl:'ê¶ì • ì™¸êµ ë§ˆë²•ì‚¬',
    cond:s => s.social >= 38 && s.know >= 28,
    txt:'ë§ˆë²•ë§Œí¼ì´ë‚˜ ë§ì˜ í˜ì„ ì´í•´í•œ ë‹¹ì‹ ì€ ì—¬ëŸ¬ ì™•êµ­ ì‚¬ì´ë¥¼ ì˜¤ê°€ë©° ì™¸êµë¥¼ ì´ëŒì—ˆë‹¤. ì „ìŸì„ ë§‰ì•„ë‚¸ ê²ƒì€ ì¢…ì¢… ë‹¹ì‹ ì˜ í•œë§ˆë””ì˜€ë‹¤.'
  },
  {
    id:'alchemist', ico:'âš—ï¸', ttl:'ëŒ€ì—°ê¸ˆìˆ ì‚¬',
    cond:s => s.know >= 30 && s.mana >= 26 && s.alchemyCount >= 8,
    txt:'ì—°ê¸ˆìˆ ì— ê¹Šì´ ëª°ë‘í•œ ë‹¹ì‹ ì€ ìƒˆë¡œìš´ ì¡°í•©ë²•ê³¼ í¬ì…˜ì„ ì‡ë‹¬ì•„ ë§Œë“¤ì–´ëƒˆë‹¤. ê·€ì¡±ê³¼ ìƒì¸ë“¤ì´ ë‹¹ì‹ ì˜ ê³µë°©ì„ ì°¾ê¸° ì‹œì‘í–ˆë‹¤.'
  },
  {
    id:'merchant', ico:'ğŸ’°', ttl:'ììˆ˜ì„±ê°€í•œ ë§ˆë²• ìƒì¸',
    cond:s => s.gold >= 180 && s.jobCount >= 18 && s.social >= 24,
    txt:'ë‹¹ì‹ ì€ ì•„ë¥´ë°”ì´íŠ¸ì™€ ê±°ë˜ë¥¼ ë°œíŒ ì‚¼ì•„ ìì‹ ë§Œì˜ ì¸ë§¥ê³¼ ìë³¸ì„ ë§Œë“¤ì—ˆë‹¤. ë§ˆë²•ì‚¬ì´ì ì‚¬ì—…ê°€ë¡œì„œ, ë‹¹ì‹ ì˜ ê°€ê²ŒëŠ” ê³§ ì‘ì€ ì œêµ­ì´ ë˜ì—ˆë‹¤.'
  },
  {
    id:'burnout', ico:'ğŸ¥€', ttl:'ë²ˆì•„ì›ƒí•œ ìˆ˜ë ¨ìƒ',
    cond:s => s.burnout >= 3 || (s.fatigue >= 85 && s.freeCount < 8),
    txt:'ë‹¹ì‹ ì€ ëˆ„êµ¬ë³´ë‹¤ ì—´ì‹¬íˆ ë‹¬ë ¸ì§€ë§Œ, ëë‚´ ìì‹ ì„ ëŒë³´ì§€ ëª»í–ˆë‹¤. ì†ì— ì¥” ê²ƒì€ ë§ì•˜ì§€ë§Œ ë§ˆìŒê³¼ ëª¸ì€ ì§€ì³ ìˆì—ˆë‹¤.'
  },
  {
    id:'debt', ico:'ğŸ’¸', ttl:'ë¹šë”ë¯¸ ìˆ˜ë ¨ìƒ',
    cond:s => s.debt >= 4,
    txt:'ìˆ˜ì—…ê³¼ ì‚¬êµë¥¼ ì«“ëŠ” ë™ì•ˆ ì§€ê°‘ì€ ì ì  ê°€ë²¼ì›Œì¡Œê³ , ê²°êµ­ ìƒí™œë¹„ì¡°ì°¨ ë¹ ë“¯í•´ì¡Œë‹¤. ê·¸ë˜ë„ ì´ ê²½í—˜ì€ ë‹¤ìŒ ì‚¶ì˜ êµí›ˆì´ ë  ê²ƒì´ë‹¤.'
  },
  {
    id:'normal', ico:'ğŸ“˜', ttl:'ë¬´ë‚œí•œ ì¡¸ì—…ìƒ',
    cond:s => (s.mana + s.know + s.body + s.social) >= 88,
    txt:'ëˆˆë¶€ì‹  ì „ì„¤ì€ ì•„ë‹ˆë”ë¼ë„, ë‹¹ì‹ ì€ ë¶„ëª…íˆ 3ë…„ì˜ ìˆ˜ë ¨ì„ ì™„ì£¼í–ˆë‹¤. ì´ì œ ì§„ì§œ ë§ˆë²•ì‚¬ì˜ ì‚¶ì´ ë‹¹ì‹  ì•ì— í¼ì³ì§„ë‹¤.'
  },
  {
    id:'bad', ico:'ğŸ’€', ttl:'ìœ ê¸‰ ìˆ˜ë ¨ìƒ',
    cond:() => true,
    txt:'3ë…„ì´ ì§€ë‚¬ì§€ë§Œ ì•„ì§ì€ ì¡°ê¸ˆ ë¶€ì¡±í–ˆë‹¤. í•˜ì§€ë§Œ ì™„ì „íˆ ëë‚œ ê²ƒì€ ì•„ë‹ˆë‹¤. ë‹¤ì‹œ ì‹œì‘í•œë‹¤ë©´ ì´ë²ˆì—” ë” ë©€ë¦¬ ê°ˆ ìˆ˜ ìˆë‹¤.'
  }
];

const ROMANCE_ENDINGS = [
  {
    id:'vain', ico:'ğŸŒ‘', ttl:'ë² ì¸ â€” ì–´ë‘  ì† ìœ ì¼í•œ ë¹›',
    cond:s => s.npc.vain >= 72 && s.mana >= 30 && s.forbidden >= 2,
    txt:'ì„¸ìƒì€ ë² ì¸ì„ ê²½ê³„í–ˆì§€ë§Œ, ê·¸ëŠ” ë‹¹ì‹  ì•ì—ì„œë§Œ ì¡°ìš©íˆ ë¬´ë„ˆì¡Œë‹¤. ê¸ˆì§€ëœ ë°¤ë“¤ ì†ì—ì„œë„ ë‹¹ì‹ ë§Œì€ ê·¸ì˜ ìœ ì¼í•œ ë¹›ì´ì—ˆë‹¤.'
  },
  {
    id:'leon', ico:'ğŸ’', ttl:'ë ˆì˜¨ â€” ì™•ê¶ì˜ ë™ë°˜ì',
    cond:s => s.npc.leon >= 70 && s.social >= 28,
    txt:'ë ˆì˜¨ì€ ìˆ˜ë§ì€ ì‹œì„  ì•ì—ì„œë„ ë§ì„¤ì´ì§€ ì•Šì•˜ë‹¤. ì™•ê¶ì˜ ì •ì›ì—ì„œ ê·¸ëŠ” ë‹¹ì‹ ì˜ ì†ì„ ì¡ê³ , í‰ìƒ í•¨ê»˜í•˜ìê³  ë§í–ˆë‹¤.'
  },
  {
    id:'cassian', ico:'ğŸ—¡ï¸', ttl:'ì¹´ì‹œì•ˆ â€” ê¸°ì‚¬ì˜ ë§¹ì„¸',
    cond:s => s.npc.cassian >= 70 && s.body >= 28,
    txt:'ì¹´ì‹œì•ˆì€ ë” ì´ìƒ ì„ë¬´ë¼ëŠ” ë§ ë’¤ì— ìˆ¨ì§€ ì•Šì•˜ë‹¤. ë‹¹ì‹  ê³ì„ ì§€í‚¤ëŠ” ê²ƒì´ ìì‹ ì˜ ì§„ì§œ ì†Œì›ì´ë¼ê³ , ê·¸ê°€ ë‚®ê²Œ ê³ ë°±í–ˆë‹¤.'
  },
  {
    id:'saren', ico:'ğŸŒŠ', ttl:'ì‚¬ë Œ â€” ë¯¸ì§€ì˜ ë•…ìœ¼ë¡œ',
    cond:s => s.npc.saren >= 68 && s.social >= 22,
    txt:'ì‚¬ë Œì€ ë§ˆì§€ë§‰ê¹Œì§€ ì¥ë‚œìŠ¤ëŸ½ê²Œ ì›ƒì—ˆì§€ë§Œ, ë– ë‚˜ëŠ” ìˆœê°„ì—” ëˆ„êµ¬ë³´ë‹¤ ì§„ì§€í–ˆë‹¤. ë‹¹ì‹ ì€ ê·¸ì˜ ì†ì„ ì¡ê³  ë‚¯ì„  ë°”ë‹¤ ë„ˆë¨¸ë¡œ í–¥í–ˆë‹¤.'
  },
  {
    id:'elias', ico:'ğŸŒ¿', ttl:'ì—˜ë¦¬ì•„ìŠ¤ â€” ì•½ì´ˆì›ì˜ í‰í™”',
    cond:s => s.npc.elias >= 70,
    txt:'ì—˜ë¦¬ì•„ìŠ¤ì™€ í•¨ê»˜í•˜ëŠ” ì‚¶ì€ í™”ë ¤í•˜ì§„ ì•Šì•„ë„ ë”°ëœ»í–ˆë‹¤. ì‘ì€ ì•½ì´ˆì›ê³¼ ì°¨ í–¥ê¸°, ê·¸ë¦¬ê³  ì„œë¡œë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ì €ë…ì´ ë§¤ì¼ì„ ì±„ì› ë‹¤.'
  },
  {
    id:'jaiden', ico:'âš”ï¸', ttl:'ì œì´ë“  â€” ì˜ì›í•œ ë¼ì´ë²Œ',
    cond:s => s.npc.jaiden >= 72 && s.body >= 24,
    txt:'ì„œë¡œë¥¼ ë°€ì–´ë¶™ì´ë©° ì„±ì¥í•˜ë˜ ë‘ ì‚¬ëŒì€ ê²°êµ­ ê°€ì¥ ê°€ê¹Œìš´ ì‚¬ëŒì´ ë˜ì—ˆë‹¤. íˆ¬ëœê±°ë¦¬ë©´ì„œë„, ê·¸ëŠ” ì–¸ì œë‚˜ ê°€ì¥ ë¨¼ì € ë‹¹ì‹ ì„ ì°¾ì•˜ë‹¤.'
  },
  {
    id:'oliver', ico:'ğŸ¤', ttl:'ì˜¬ë¦¬ë²„ â€” í˜„ìì˜ ë™ë°˜ì',
    cond:s => s.npc.oliver >= 70 && s.know >= 28,
    txt:'ì˜¬ë¦¬ë²„ëŠ” ëë‚´ ê°ì •ì„ ê³µì‹ì²˜ëŸ¼ ì„¤ëª…í•˜ì§€ ëª»í–ˆë‹¤. í•˜ì§€ë§Œ ë‹¹ì‹ ê³¼ í•¨ê»˜ ìˆì„ ë•Œë§Œí¼ì€, ê·¸ ì¹¨ë¬µ ìì²´ê°€ ê°€ì¥ ë¶„ëª…í•œ ëŒ€ë‹µì´ì—ˆë‹¤.'
  }
];

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ìƒíƒœ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

let G = {};
let alloc = { mana:5, know:5, body:5, social:5 };
let pts = 20;

let _q = [];
let _qi = 0;

let _evCb = null;
let _lvCb = null;
let _lvNpc = null;
let _lvMark = null;

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ìœ í‹¸
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

function baseCounts() {
  return {
    job:0,
    class:0,
    social:0,
    free:0,
    forbidden:0,
    dates:0,
    scholarship:0,
    burnout:0,
    debt:0,
    byAct:{}
  };
}

function initGame(name, stats) {
  G = {
    name,
    turn:1,
    totalTurns:36,
    gold:200,
    fatigue:0,
    stats:{
      mana:stats.mana,
      know:stats.know,
      body:stats.body,
      social:stats.social
    },
    npc:{
      leon:0,
      cassian:0,
      saren:0,
      vain:0,
      elias:0,
      jaiden:0,
      oliver:0
    },
    counts: baseCounts(),
    selAM:null,
    selPM:null,
    forcedRest:false,
    triggered:{},
    log:[]
  };
}

function normalizeGameState(src) {
  const counts = Object.assign(baseCounts(), src.counts || {});
  counts.byAct = counts.byAct || {};

  return {
    name: src.name || 'ì•„ë¦¬ì•„',
    turn: Math.max(1, src.turn || 1),
    totalTurns: 36,
    gold: Math.max(0, src.gold ?? 200),
    fatigue: clamp(src.fatigue ?? 0),
    stats: {
      mana: Math.max(0, src.stats?.mana ?? 5),
      know: Math.max(0, src.stats?.know ?? 5),
      body: Math.max(0, src.stats?.body ?? 5),
      social: Math.max(0, src.stats?.social ?? 5),
    },
    npc: {
      leon: clamp(src.npc?.leon ?? 0),
      cassian: clamp(src.npc?.cassian ?? 0),
      saren: clamp(src.npc?.saren ?? 0),
      vain: clamp(src.npc?.vain ?? 0),
      elias: clamp(src.npc?.elias ?? 0),
      jaiden: clamp(src.npc?.jaiden ?? 0),
      oliver: clamp(src.npc?.oliver ?? 0),
    },
    counts,
    selAM: src.selAM ?? null,
    selPM: src.selPM ?? null,
    forcedRest: !!src.forcedRest,
    triggered: src.triggered || {},
    log: Array.isArray(src.log) ? src.log : []
  };
}

function migrateLegacySave(old) {
  return normalizeGameState({
    name: old.name,
    turn: old.turn,
    totalTurns: 36,
    gold: old.gold,
    fatigue: old.fatigue,
    stats: old.stats,
    npc: old.npc,
    selAM: null,
    selPM: null,
    forcedRest: old.forcedRest,
    triggered: old.triggered,
    log: (old.log || []).map(item => {
      if (typeof item === 'string') return { mark:'ê¸°ë¡', txt:item, cls:'' };
      return {
        mark: item.mark || 'ê¸°ë¡',
        txt: item.txt || '',
        cls: item.cls || ''
      };
    })
  });
}

function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

function getYear() { return Math.ceil(G.turn / 12); }
function getMonth() { return ((G.turn - 1) % 12) + 1; }

function getSeason() {
  const m = getMonth();
  if (m <= 3) return ['ë´„','sp'];
  if (m <= 6) return ['ì—¬ë¦„','su'];
  if (m <= 9) return ['ê°€ì„','au'];
  return ['ê²¨ìš¸','wi'];
}

function clamp(v, mn=0, mx=100) {
  return Math.max(mn, Math.min(mx, v));
}

function isDateSlot(v) {
  return typeof v === 'string' && v.startsWith('date:');
}

function applyEff(eff) {
  for (const [k, v] of Object.entries(eff || {})) {
    if (k === 'fat') G.fatigue = clamp(G.fatigue + v);
    else if (k === 'gold') G.gold = Math.max(0, G.gold + v);
    else if (G.stats[k] !== undefined) G.stats[k] = Math.max(0, G.stats[k] + v);
  }
}

function addLog(txt, cls='', mark=null) {
  const label = mark || `${getYear()}ë…„ ${getMonth()}ì›”`;
  G.log.unshift({ mark:label, txt, cls });
  if (G.log.length > 50) G.log.pop();
  renderLog();
}

function renderLog() {
  const p = document.getElementById('log-panel');
  let h = '<div class="px7" style="color:var(--dim);margin-bottom:4px">â€” ê¸°ë¡ â€”</div>';
  const slice = G.log.slice(0, 24);
  for (const item of slice) {
    const cls = item.cls ? ' le-' + item.cls : '';
    h += `<div class="le${cls}">[${item.mark}] ${item.txt}</div>`;
  }
  p.innerHTML = h;
}

function saveGame() {
  localStorage.setItem(SAVE_KEY, JSON.stringify(G));
}

function clearSave() {
  localStorage.removeItem(SAVE_KEY);
  localStorage.removeItem('mageAcad_v2');
}

function getAvailableActs() {
  return ACTS.filter(a => getYear() >= (a.unlock || 1));
}

function getActById(id) {
  return ACTS.find(a => a.id === id);
}

function slotText(v) {
  if (!v) return { txt:'ì„ íƒ ì•ˆ í•¨', empty:true };
  if (isDateSlot(v)) {
    const npcId = v.split(':')[1];
    const npc = NPCS.find(n => n.id === npcId);
    return { txt: npc ? `ğŸ’• ${npc.name} ë°ì´íŠ¸` : 'ğŸ’• ë°ì´íŠ¸', empty:false };
  }
  const a = getActById(v);
  return a ? { txt:`${a.icon} ${a.name}`, empty:false } : { txt:'ì„ íƒ ì•ˆ í•¨', empty:true };
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ì´ˆê¸°í™”
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

document.addEventListener('DOMContentLoaded', () => {
  for (let i = 0; i < 70; i++) {
    const s = document.createElement('div');
    s.className = 'star';
    s.style.cssText = `
      left:${Math.random()*100}%;
      top:${Math.random()*100}%;
      width:${Math.random()*2+1}px;
      height:${Math.random()*2+1}px;
      animation-delay:${Math.random()*3}s;
      animation-duration:${2+Math.random()*3}s
    `;
    document.body.appendChild(s);
  }

  if (localStorage.getItem(SAVE_KEY) || localStorage.getItem('mageAcad_v2')) {
    document.getElementById('load-btn').style.display = 'inline-block';
  }

  document.getElementById('new-game-btn').addEventListener('click', startCreate);
  document.getElementById('load-btn').addEventListener('click', loadGame);
  document.getElementById('back-btn').addEventListener('click', () => showScreen('screen-title'));
  document.getElementById('start-btn').addEventListener('click', confirmCreate);
  document.getElementById('confirm-btn').addEventListener('click', confirmMonth);
  document.getElementById('date-btn').addEventListener('click', openDateMenu);
  document.getElementById('restart-btn').addEventListener('click', restartGame);
  document.getElementById('ev-close-btn').addEventListener('click', closeEvModal);
  document.getElementById('date-cancel-btn').addEventListener('click', closeDateModal);
  document.getElementById('npc-close-btn').addEventListener('click', closeNpcModal);

  ['ev-modal','npc-modal','date-modal'].forEach(id => {
    document.getElementById(id).addEventListener('click', e => {
      if (e.target === e.currentTarget) document.getElementById(id).classList.remove('open');
    });
  });

  document.getElementById('lv-modal').addEventListener('click', e => {
    if (e.target === e.currentTarget) closeLvModal();
  });
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ìºë¦­í„° ìƒì„±
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

function startCreate() {
  alloc = { mana:5, know:5, body:5, social:5 };
  pts = 20;
  document.getElementById('char-name').value = '';
  showScreen('screen-create');
  renderAlloc();
}

function renderAlloc() {
  const defs = [
    ['mana','âœ¨ ë§ˆë ¥','s-mana'],
    ['know','ğŸ“š ì§€ì‹','s-know'],
    ['body','ğŸ’ª ì²´ë ¥','s-body'],
    ['social','ğŸ’¬ ì‚¬êµ','s-soc']
  ];

  let h = '';
  for (const [k, lbl, cls] of defs) {
    const v = alloc[k];
    h += `
      <div class="srow ${cls}">
        <span class="slbl">${lbl}</span>
        <div class="sbw"><div class="sbf" style="width:${v * 4}%"></div></div>
        <span class="sn">${v}</span>
        <button class="sbtn" onclick="adj('${k}',-1)">âˆ’</button>
        <button class="sbtn" onclick="adj('${k}',1)">+</button>
      </div>
    `;
  }

  document.getElementById('stat-alloc').innerHTML = h;
  document.getElementById('pts').textContent = pts;
}

function adj(k, d) {
  if (d > 0 && pts <= 0) return;
  if (d < 0 && alloc[k] <= 1) return;
  alloc[k] += d;
  pts -= d;
  renderAlloc();
}

function confirmCreate() {
  const name = document.getElementById('char-name').value.trim() || 'ì•„ë¦¬ì•„';
  initGame(name, { ...alloc });
  startGame();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ë Œë”
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

function startGame() {
  showScreen('screen-game');
  renderAll();
}

function renderAll() {
  renderHUD();
  renderStatPanel();
  renderActGrid();
  renderNpcList();
  renderShop();
  renderLog();
}

function renderHUD() {
  document.getElementById('hd-name').textContent = G.name;
  document.getElementById('hd-gold').textContent = G.gold;
  document.getElementById('hd-prog').style.width = (Math.min(G.turn, G.totalTurns) / G.totalTurns * 100) + '%';
  document.getElementById('hd-turn').textContent = Math.min(G.turn, G.totalTurns) + '/' + G.totalTurns;

  const [sn, sc] = getSeason();
  document.getElementById('hd-date').textContent = `${getYear()}ë…„ì°¨ ${getMonth()}ì›”`;
  document.getElementById('hd-season').innerHTML = `<span class="stag ${sc}">${sn}</span>`;
  document.getElementById('m-info').textContent = G.forcedRest
    ? `âš ï¸ ${getYear()}ë…„ì°¨ ${getMonth()}ì›” â€” ê°•ì œ íœ´ì‹ (í™œë™ ë¶ˆê°€)`
    : `${getYear()}ë…„ì°¨ ${getMonth()}ì›” â€” ì´ë‹¬ì˜ í™œë™ì„ ì„ íƒí•˜ì„¸ìš”`;
}

function renderStatPanel() {
  const defs = [
    ['mana','âœ¨ ë§ˆë ¥','sd-mana'],
    ['know','ğŸ“š ì§€ì‹','sd-know'],
    ['body','ğŸ’ª ì²´ë ¥','sd-body'],
    ['social','ğŸ’¬ ì‚¬êµ','sd-soc']
  ];

  let h = '';
  for (const [k, lbl, cls] of defs) {
    const v = Math.min(G.stats[k], 100);
    h += `
      <div class="sdr ${cls}">
        <span class="sdlbl">${lbl}</span>
        <div class="sdb"><div class="sdf" style="width:${v}%"></div></div>
        <span class="sdn">${G.stats[k]}</span>
      </div>
    `;
  }
  document.getElementById('stat-panel').innerHTML = h;

  document.getElementById('fat-num').textContent = G.fatigue + '/100';
  const ff = document.getElementById('fat-fill');
  ff.style.width = G.fatigue + '%';
  ff.style.background = G.fatigue >= 80 ? '#ff4040' : G.fatigue >= 50 ? '#ff9040' : '#40e880';

  let b = '';
  if (G.fatigue >= 80) b += '<span class="badge b-bad">âš ï¸ ê³¼ë¡œ</span>';
  else if (G.fatigue >= 50) b += '<span class="badge b-warn">ğŸ˜° í”¼ë¡œ</span>';
  else b += '<span class="badge b-ok">âœ… ì •ìƒ</span>';

  if (G.forcedRest) b += '<span class="badge b-bad">ğŸ›Œ ê°•ì œ íœ´ì‹</span>';
  if (G.gold < 30) b += '<span class="badge b-warn">ğŸ’¸ ìê¸ˆ ë¶€ì¡±</span>';
  if (G.counts.forbidden >= 3) b += '<span class="badge b-warn">ğŸŒ‘ ê¸ˆì§€ ì§€ì‹</span>';

  document.getElementById('badges').innerHTML = b;
}

function renderActGrid() {
  const am = slotText(G.selAM);
  const pm = slotText(G.selPM);

  const amEl = document.getElementById('slot-am');
  const pmEl = document.getElementById('slot-pm');

  amEl.textContent = am.txt;
  pmEl.textContent = pm.txt;
  amEl.classList.toggle('empty', am.empty);
  pmEl.classList.toggle('empty', pm.empty);

  if (G.forcedRest) {
    document.getElementById('act-grid').innerHTML =
      '<div class="px8" style="color:var(--red);grid-column:span 4;text-align:center;padding:18px;line-height:2">ğŸ›Œ ì´ë‹¬ì€ ê°•ì œ íœ´ì‹ì…ë‹ˆë‹¤.<br>íœ´ì‹ë§Œì´ í—ˆë½ë©ë‹ˆë‹¤.</div>';
    return;
  }

  const groups = [
    { key:'job', label:'ğŸ§¹ ì•„ë¥´ë°”ì´íŠ¸ â€” ëˆ ë²Œê¸° / ì„±ì¥ ì ìŒ' },
    { key:'class', label:'ğŸ“š ìˆ˜ì—… â€” ëˆ ì“°ê¸° / ì„±ì¥ í¼' },
    { key:'social', label:'ğŸ­ ì‚¬êµ â€” ëˆ ì“°ê¸° / ì´ë²¤íŠ¸ ê°•í™”' },
    { key:'free', label:'ğŸ˜´ ë¬´ë£Œ í–‰ë™ â€” íšŒë³µ / ì†Œì„±ì¥' }
  ];

  const acts = getAvailableActs();
  let h = '';

  for (const g of groups) {
    const list = acts.filter(a => a.type === g.key);
    if (!list.length) continue;

    h += `<div class="cat-head">${g.label}</div>`;

    for (const a of list) {
      const selected = G.selAM === a.id || G.selPM === a.id;
      const individuallyAffordable = !(a.gold < 0 && G.gold < Math.abs(a.gold));
      const disabledClass = individuallyAffordable ? '' : ' dis';

      const statStr = Object.entries(a.stat || {})
        .map(([k,v]) => ({ mana:'ë§ˆë ¥', know:'ì§€ì‹', body:'ì²´ë ¥', social:'ì‚¬êµ' }[k] + (v > 0 ? '+' : '') + v))
        .join(' ');

      const goldStr = a.gold !== 0
        ? (a.gold > 0 ? ` ğŸ’°+${a.gold}G` : ` ğŸ’¸${a.gold}G`)
        : '';

      const fatStr = a.fat !== 0
        ? (a.fat > 0 ? ` í”¼ë¡œ+${a.fat}` : ` í”¼ë¡œ${a.fat}`)
        : '';

      h += `
        <button class="ab${selected ? ' sel' : ''}${disabledClass}" onclick="selAct('${a.id}')">
          <span class="ai">${a.icon}</span>
          <span class="an">${a.name}</span>
          <span class="ac">${statStr || 'ë³€í™” ì ìŒ'}${goldStr}<br>${fatStr}</span>
        </button>
      `;
    }
  }

  document.getElementById('act-grid').innerHTML = h;
}

function selAct(id) {
  if (G.forcedRest) return;

  const act = getActById(id);
  if (!act) return;

  if (act.gold < 0 && G.gold < Math.abs(act.gold)) {
    addLog(`ğŸ’¸ ${act.name} ë¹„ìš©ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.`, 'bad');
    return;
  }

  if (G.selAM === id) {
    G.selAM = null;
    renderActGrid();
    saveGame();
    return;
  }

  if (G.selPM === id) {
    G.selPM = null;
    renderActGrid();
    saveGame();
    return;
  }

  const pmIsDate = isDateSlot(G.selPM);

  if (!G.selAM) G.selAM = id;
  else if (!G.selPM) G.selPM = id;
  else if (pmIsDate) G.selAM = id;
  else {
    G.selAM = G.selPM;
    G.selPM = id;
  }

  renderActGrid();
  saveGame();
}

function renderNpcList() {
  let h = '';
  let anyDate = false;

  for (const npc of NPCS) {
    const met = npc.meet(G.turn);
    const heart = G.npc[npc.id];

    if (heart >= 30 && met) anyDate = true;

    h += `
      <div class="nc${met ? '' : ' locked'}" ${met ? `onclick="openNpcModal('${npc.id}')"` : ''}>
        <span class="ni">${npc.icon}</span>
        <div style="flex:1;min-width:0">
          <span class="nn">${npc.name}${met ? '' : ' ğŸ”’'}</span>
          <div class="nh"><div class="nhf" style="width:${heart}%"></div></div>
        </div>
        <span class="hnum">${met ? heart : '?'}</span>
      </div>
    `;
  }

  document.getElementById('npc-list').innerHTML = h;

  const db = document.getElementById('date-btn');
  db.style.display = (anyDate && !G.forcedRest) ? 'block' : 'none';
  db.textContent = isDateSlot(G.selPM) ? 'ğŸ’• ë°ì´íŠ¸ ë³€ê²½' : 'ğŸ’• ë°ì´íŠ¸ ì‹ ì²­';
}

function renderShop() {
  let h = '';

  for (const it of SHOP) {
    h += `
      <div class="sh-item">
        <span style="font-size:11px;line-height:1.5">${it.name}</span>
        <button class="btn btn-xs" onclick="buyItem('${it.id}')" ${G.gold < it.cost ? 'disabled' : ''} title="${it.desc}">
          ${it.cost}G
        </button>
      </div>
    `;
  }

  document.getElementById('shop-list').innerHTML = h;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ì§„í–‰
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

function confirmMonth() {
  if (!G.forcedRest && !G.selAM && !G.selPM) {
    addLog('í™œë™ì„ ìµœì†Œ 1ê°œ ì„ íƒí•˜ì„¸ìš”.');
    return;
  }

  const monthMark = `${getYear()}ë…„ ${getMonth()}ì›”`;
  const monthAM = G.selAM;
  const monthPM = G.selPM;

  _q = [];
  _qi = 0;

  if (G.forcedRest) {
    G.fatigue = clamp(G.fatigue - 45);
    addLog('ğŸ›Œ ê°•ì œ íœ´ì‹. í”¼ë¡œ âˆ’45', 'good', monthMark);
    G.forcedRest = false;
  } else {
    for (const slot of [monthAM, monthPM]) {
      if (!slot) continue;
      if (isDateSlot(slot)) {
        doDateActivity(slot.split(':')[1], monthMark);
      } else {
        const act = getActById(slot);
        if (act) doActivity(act, monthMark);
      }
    }

    applyComboBonus(monthAM, monthPM, monthMark);
  }

  applyLivingCost(monthMark);
  applySemesterScholarship(monthMark);

  if (G.fatigue >= 90 && !G.forcedRest) {
    G.forcedRest = true;
    G.counts.burnout++;
    _q.push({
      type:'sys',
      ico:'ğŸ›Œ',
      ttl:'ê³¼ë¡œë¡œ ì“°ëŸ¬ì§',
      txt:'ê·¹ì‹¬í•œ í”¼ë¡œë¡œ ì“°ëŸ¬ì¡Œë‹¤. ë‹¤ìŒ ë‹¬ì€ ê°•ì œ íœ´ì‹ì´ë‹¤.',
      tags:['ë‹¤ìŒ ë‹¬ ê°•ì œ íœ´ì‹'],
      mark: monthMark
    });
    addLog('âš ï¸ ê³¼ë¡œ ì“°ëŸ¬ì§! ë‹¤ìŒ ë‹¬ ê°•ì œ íœ´ì‹', 'bad', monthMark);
  }

  for (const npc of NPCS) {
    for (const ev of npc.events) {
      const key = npc.id + '_' + ev.t;
      if (ev.t === G.turn && !G.triggered[key] && npc.meet(G.turn)) {
        G.triggered[key] = true;
        _q.push({ type:'npc', npc, ev, mark: monthMark });
      }
    }
  }

  if (Math.random() < 0.12) {
    _q.push({ type:'rand', ev: RANDS[Math.floor(Math.random() * RANDS.length)], mark: monthMark });
  }

  G.selAM = null;
  G.selPM = null;

  G.turn++;
  saveGame();
  renderAll();
  runQueue();
}

function doActivity(act, monthMark) {
  if (act.gold < 0 && G.gold < Math.abs(act.gold)) {
    addLog(`ğŸ’¸ ${act.name} ë¹„ìš©ì´ ë¶€ì¡±í•´ ì°¸ì—¬í•˜ì§€ ëª»í–ˆë‹¤.`, 'bad', monthMark);
    _q.push({
      type:'sys',
      ico:'ğŸ’¸',
      ttl:'ë¹„ìš© ë¶€ì¡±',
      txt:`${act.name} ë¹„ìš©ì´ ë¶€ì¡±í•´ ì°¸ì—¬í•˜ì§€ ëª»í–ˆë‹¤.`,
      tags:['í–‰ë™ ë¬´íš¨'],
      mark: monthMark
    });
    return;
  }

  if (act.fail && Math.random() < act.fail) {
    const fs = act.fstat || {};
    for (const [k, v] of Object.entries(fs)) {
      if (k === 'fat') G.fatigue = clamp(G.fatigue + v);
      else if (k === 'gold') G.gold = Math.max(0, G.gold + v);
      else G.stats[k] = Math.max(0, (G.stats[k] || 0) + v);
    }
    addLog('âŒ ' + act.ftxt, 'bad', monthMark);
    _q.push({
      type:'sys',
      ico:'âŒ',
      ttl:'í™œë™ ì‹¤íŒ¨',
      txt:act.ftxt,
      tags:[],
      mark: monthMark
    });
    return;
  }

  for (const [k, v] of Object.entries(act.stat || {})) {
    G.stats[k] = Math.max(0, (G.stats[k] || 0) + v);
  }

  G.fatigue = clamp(G.fatigue + (act.fat || 0));
  if (act.gold) G.gold = Math.max(0, G.gold + act.gold);

  G.counts[act.type] = (G.counts[act.type] || 0) + 1;
  G.counts.byAct[act.id] = (G.counts.byAct[act.id] || 0) + 1;
  if (act.forbidden) G.counts.forbidden++;

  const statStr = Object.entries(act.stat || {})
    .map(([k, v]) => ({ mana:'ë§ˆë ¥', know:'ì§€ì‹', body:'ì²´ë ¥', social:'ì‚¬êµ' }[k] + (v > 0 ? '+' : '') + v))
    .join(' ');

  addLog(
    `${act.icon} ${act.name}${statStr ? ' (' + statStr + ')' : ''}${act.gold ? (act.gold > 0 ? ' +' : ' ') + act.gold + 'G' : ''}`,
    'good',
    monthMark
  );

  if (act.npc && Math.random() < (act.nc || 0)) {
    const npc = NPCS.find(n => n.id === act.npc);
    if (npc && npc.meet(G.turn)) {
      const gain = act.type === 'social' ? 3 : 2;
      G.npc[act.npc] = clamp(G.npc[act.npc] + gain);
      addLog(`â¤ï¸ ${npc.name}ì™€(ê³¼) ê°€ê¹Œì›Œì¡Œë‹¤. í˜¸ê°ë„ +${gain}`, 'heart', monthMark);
    }
  }
}

function doDateActivity(npcId, monthMark) {
  const npc = NPCS.find(n => n.id === npcId);
  if (!npc) return;

  const evList = DATE_EVS[npcId] || [];
  let ev = evList.filter(e => G.npc[npcId] >= e.req).pop();

  if (!ev) {
    ev = {
      fat:8,
      h:5,
      txt:`${npc.name}ì™€(ê³¼) ì¡°ìš©í•œ ì‹œê°„ì„ ë³´ëƒˆë‹¤. ì§§ì•˜ì§€ë§Œ ë¶„ëª…íˆ ë§ˆìŒì´ ê°€ê¹Œì›Œì¡Œë‹¤.`
    };
  }

  G.fatigue = clamp(G.fatigue + (ev.fat || 8));
  G.counts.dates++;
  _q.push({ type:'date', npc, ev, mark: monthMark });
}

function applyComboBonus(am, pm, monthMark) {
  if (!am || !pm) return;
  if (isDateSlot(am) || isDateSlot(pm)) return;

  const pair = [am, pm].sort().join('|');

  if (pair === ['alchemy_assist','alchemy_practicum'].sort().join('|')) {
    G.stats.mana += 1;
    G.stats.know += 1;
    G.gold += 5;
    addLog('ğŸ”— ì—°ê¸ˆ ì‹œë„ˆì§€! ë§ˆë ¥ +1, ì§€ì‹ +1, ê³¨ë“œ +5G', 'good', monthMark);
  }
  else if (pair === ['wall_guard','martial_basics'].sort().join('|')) {
    G.stats.body += 1;
    G.npc.cassian = clamp(G.npc.cassian + 2);
    addLog('ğŸ”— ì „íˆ¬ ì‹œë„ˆì§€! ì²´ë ¥ +1, ì¹´ì‹œì•ˆ í˜¸ê°ë„ +2', 'heart', monthMark);
  }
  else if (pair === ['banquet_service','royal_tea'].sort().join('|')) {
    G.stats.social += 2;
    G.npc.leon = clamp(G.npc.leon + 2);
    addLog('ğŸ”— ê¶ì • ì¸ë§¥ ì‹œë„ˆì§€! ì‚¬êµ +2, ë ˆì˜¨ í˜¸ê°ë„ +2', 'heart', monthMark);
  }
  else if (pair === ['market_delivery','night_market'].sort().join('|')) {
    G.stats.social += 1;
    G.gold += 8;
    G.npc.saren = clamp(G.npc.saren + 2);
    addLog('ğŸ”— ì‹œì¥ ì¸ë§¥ ì‹œë„ˆì§€! ì‚¬êµ +1, ê³¨ë“œ +8G, ì‚¬ë Œ í˜¸ê°ë„ +2', 'heart', monthMark);
  }
  else if (pair === ['library_sorting','ancient_texts'].sort().join('|')) {
    G.stats.know += 1;
    G.npc.oliver = clamp(G.npc.oliver + 2);
    addLog('ğŸ”— ì—°êµ¬ ì‹œë„ˆì§€! ì§€ì‹ +1, ì˜¬ë¦¬ë²„ í˜¸ê°ë„ +2', 'heart', monthMark);
  }
  else if (pair === ['forbidden_decoding','secret_archive'].sort().join('|')) {
    G.stats.mana += 2;
    G.stats.know += 1;
    G.counts.forbidden++;
    G.npc.vain = clamp(G.npc.vain + 3);
    addLog('ğŸ”— ê¸ˆì§€ ì§€ì‹ ê³µëª…! ë§ˆë ¥ +2, ì§€ì‹ +1, ë² ì¸ í˜¸ê°ë„ +3', 'heart', monthMark);
  }

  G.stats.mana = Math.max(0, G.stats.mana);
  G.stats.know = Math.max(0, G.stats.know);
  G.stats.body = Math.max(0, G.stats.body);
  G.stats.social = Math.max(0, G.stats.social);
}

function applyLivingCost(monthMark) {
  if (G.gold >= 12) {
    G.gold -= 12;
    addLog('ğŸ’¸ ìƒí™œë¹„ 12G ì°¨ê°', 'bad', monthMark);
  } else {
    G.counts.debt++;
    G.stats.social = Math.max(0, G.stats.social - 2);
    addLog('âš ï¸ ìƒí™œë¹„ ë¶€ì¡±! ì‚¬êµ âˆ’2', 'bad', monthMark);
  }

  if (G.gold === 0) G.counts.debt++;
}

function applySemesterScholarship(monthMark) {
  if (G.turn % 6 !== 0) return;

  const score =
    G.stats.mana +
    G.stats.know +
    G.stats.body +
    G.stats.social +
    (G.counts.class * 2);

  let reward = 0;
  if (score >= 120) reward = 40;
  else if (score >= 95) reward = 25;

  if (reward > 0) {
    G.gold += reward;
    G.counts.scholarship++;
    addLog(`ğŸ… í•™ê¸° ì¥í•™ê¸ˆ +${reward}G`, 'good', monthMark);
    _q.push({
      type:'sys',
      ico:'ğŸ…',
      ttl:'í•™ê¸° ì¥í•™ê¸ˆ',
      txt:`ì´ë²ˆ í•™ê¸° ì„±ì ì´ ìš°ìˆ˜í•˜ì—¬ ì¥í•™ê¸ˆ ${reward}Gë¥¼ ë°›ì•˜ë‹¤.`,
      tags:[`ê³¨ë“œ +${reward}G`],
      mark: monthMark
    });
  }
}

function runQueue() {
  if (_qi >= _q.length) {
    checkEnding();
    return;
  }

  const item = _q[_qi++];

  if (item.type === 'sys') {
    showEvModal(item.ico, item.ttl, item.txt, item.tags || [], runQueue);
  }
  else if (item.type === 'rand') {
    applyEff(item.ev.eff);
    renderAll();
    addLog('ğŸŒ€ ' + item.ev.ttl, 'ev', item.mark);
    showEvModal(item.ev.ico, item.ev.ttl, item.ev.txt, item.ev.tags, runQueue);
  }
  else if (item.type === 'npc') {
    showLoveScene(item.npc, item.ev, runQueue, 'ì´ë²¤íŠ¸', item.mark);
  }
  else if (item.type === 'date') {
    showLoveScene(item.npc, item.ev, runQueue, 'ë°ì´íŠ¸', item.mark);
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ëª¨ë‹¬
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

function showEvModal(ico, ttl, txt, tags, cb) {
  document.getElementById('ev-ico').textContent = ico;
  document.getElementById('ev-ttl').textContent = ttl;
  document.getElementById('ev-txt').textContent = txt;
  document.getElementById('ev-tags').innerHTML = (tags || []).map(t =>
    `<span class="tag ${String(t).includes('âˆ’') || String(t).includes('-') ? 'tn' : 'tp'}">${t}</span>`
  ).join('');
  _evCb = cb;
  document.getElementById('ev-modal').classList.add('open');
}

function closeEvModal() {
  document.getElementById('ev-modal').classList.remove('open');
  if (_evCb) {
    const f = _evCb;
    _evCb = null;
    f();
  }
}

function showLoveScene(npc, ev, cb, label='ì´ë²¤íŠ¸', mark=null) {
  const baseGain = ev.h || 0;
  if (baseGain) G.npc[npc.id] = clamp(G.npc[npc.id] + baseGain);

  addLog(`${label === 'ë°ì´íŠ¸' ? 'ğŸ’•' : 'ğŸ’Œ'} ${npc.name} ${label}! í˜¸ê°ë„ +${baseGain}`, 'heart', mark);
  renderAll();

  _lvNpc = npc;
  _lvCb = cb;
  _lvMark = mark;
  window._lvRes = ev.res || [];

  document.getElementById('lv-ico').textContent = npc.icon;
  document.getElementById('lv-ttl').textContent = `${npc.name} â€” ${label}`;
  document.getElementById('lv-txt').textContent = ev.txt;

  const cl = document.getElementById('lv-choices');
  if (ev.choices && ev.choices.length) {
    cl.innerHTML = ev.choices.map((c, i) =>
      `<button class="chbtn" onclick="pickNpcChoice(${i})">${c}</button>`
    ).join('');
  } else {
    cl.innerHTML = `<button class="btn btn-sm" onclick="closeLvModal()">í™•ì¸</button>`;
  }

  document.getElementById('lv-modal').classList.add('open');
}

function pickNpcChoice(i) {
  const res = (window._lvRes || [])[i];
  if (!res) return;

  if (_lvNpc) {
    G.npc[_lvNpc.id] = clamp(G.npc[_lvNpc.id] + (res.h || 0));
    addLog(`ğŸ’¬ ${res.txt} í˜¸ê°ë„ +${res.h || 0}`, 'heart', _lvMark);
  }

  document.getElementById('lv-txt').textContent = res.txt;
  document.getElementById('lv-choices').innerHTML = `<button class="btn btn-sm" onclick="closeLvModal()">í™•ì¸</button>`;
  window._lvRes = [];
  renderAll();
  saveGame();
}

function closeLvModal() {
  document.getElementById('lv-modal').classList.remove('open');
  _lvMark = null;

  if (_lvCb) {
    const f = _lvCb;
    _lvCb = null;
    _lvNpc = null;
    window._lvRes = [];
    f();
  } else {
    _lvNpc = null;
    window._lvRes = [];
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ë°ì´íŠ¸
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

function openDateMenu() {
  if (G.forcedRest) return;

  const list = NPCS.filter(n => G.npc[n.id] >= 30 && n.meet(G.turn));
  if (!list.length) return;

  document.getElementById('date-choices').innerHTML = list.map(n =>
    `<button class="chbtn" onclick="startDate('${n.id}')">${n.icon} ${n.name} <span style="color:var(--pink);font-family:var(--px);font-size:7px">â¤ï¸${G.npc[n.id]}</span></button>`
  ).join('');

  document.getElementById('date-modal').classList.add('open');
}

function closeDateModal() {
  document.getElementById('date-modal').classList.remove('open');
}

function startDate(npcId) {
  closeDateModal();
  G.selPM = `date:${npcId}`;
  renderActGrid();
  renderNpcList();
  saveGame();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   NPC ìƒì„¸
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

function openNpcModal(id) {
  const npc = NPCS.find(n => n.id === id);
  if (!npc) return;

  const h = G.npc[id];

  document.getElementById('nm-ico').textContent = npc.icon;
  document.getElementById('nm-name').textContent = npc.name;
  document.getElementById('nm-title').textContent = npc.title;
  document.getElementById('nm-desc').textContent = npc.desc;
  document.getElementById('nm-hf').style.width = h + '%';
  document.getElementById('nm-hn').textContent = h + '/100';

  document.getElementById('nm-stage').textContent =
    h >= 70 ? 'ğŸ’– ê¹Šì€ ì‹ ë¢°' :
    h >= 50 ? 'ğŸ’— ì¹œë°€' :
    h >= 30 ? 'ğŸ©· í˜¸ê°' :
    h >= 10 ? 'ğŸ¤ ì§€ì¸' : 'ğŸ‘¤ ë‚¯ì„  ì‚¬ëŒ';

  const nxt = npc.events.find(e => !G.triggered[npc.id + '_' + e.t] && e.t >= G.turn);
  document.getElementById('nm-next').textContent = nxt
    ? `ë‹¤ìŒ ì´ë²¤íŠ¸ê¹Œì§€ ì•½ ${nxt.t - G.turn + 1}ê°œì›”`
    : 'ì£¼ìš” ì´ë²¤íŠ¸ ì™„ë£Œ âœ¨';

  document.getElementById('npc-modal').classList.add('open');
}

function closeNpcModal() {
  document.getElementById('npc-modal').classList.remove('open');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ìƒì 
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

function buyItem(id) {
  const it = SHOP.find(x => x.id === id);
  if (!it || G.gold < it.cost) return;

  G.gold -= it.cost;
  applyEff(it.eff);
  addLog(`ğŸ›ï¸ ${it.name} êµ¬ë§¤ (${it.desc})`, 'good');
  renderAll();
  saveGame();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ì—”ë”©
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

function getEndingSnapshot() {
  return {
    mana: G.stats.mana,
    know: G.stats.know,
    body: G.stats.body,
    social: G.stats.social,
    gold: G.gold,
    fatigue: G.fatigue,
    npc: G.npc,
    scholarship: G.counts.scholarship,
    forbidden: G.counts.forbidden,
    burnout: G.counts.burnout,
    debt: G.counts.debt,
    dates: G.counts.dates,
    jobCount: G.counts.job,
    classCount: G.counts.class,
    socialCount: G.counts.social,
    freeCount: G.counts.free,
    alchemyCount: (G.counts.byAct.alchemy_assist || 0) + (G.counts.byAct.alchemy_practicum || 0)
  };
}

function checkEnding() {
  if (G.turn <= G.totalTurns) return;

  const s = getEndingSnapshot();
  const main = MAIN_ENDINGS.find(e => e.cond(s)) || MAIN_ENDINGS[MAIN_ENDINGS.length - 1];

  const romanceCandidates = ROMANCE_ENDINGS.filter(r => r.cond(s));
  let romance = null;
  if (romanceCandidates.length) {
    romance = romanceCandidates.sort((a, b) => {
      const aId = a.id;
      const bId = b.id;
      return (G.npc[bId] || 0) - (G.npc[aId] || 0);
    })[0];
  }

  showEnding(main, romance);
}

function showEnding(main, romance) {
  document.getElementById('en-ico').textContent = main.ico;
  document.getElementById('en-main-ttl').textContent = main.ttl;
  document.getElementById('en-main-txt').textContent = main.txt;

  const romWrap = document.getElementById('en-rom-wrap');
  if (romance) {
    romWrap.style.display = 'block';
    document.getElementById('en-rom-ttl').textContent = romance.ttl;
    document.getElementById('en-rom-txt').textContent = romance.txt;
  } else {
    romWrap.style.display = 'none';
  }

  document.getElementById('en-meta').innerHTML = `
    ì´ ì•„ë¥´ë°”ì´íŠ¸ <span style="color:var(--gold)">${G.counts.job}</span>íšŒ /
    ìˆ˜ì—… <span style="color:var(--know)">${G.counts.class}</span>íšŒ /
    ì‚¬êµ <span style="color:var(--pink)">${G.counts.social}</span>íšŒ /
    ë¬´ë£Œ í–‰ë™ <span style="color:var(--grn)">${G.counts.free}</span>íšŒ<br>
    ë°ì´íŠ¸ <span style="color:var(--pink)">${G.counts.dates}</span>íšŒ /
    ì¥í•™ê¸ˆ <span style="color:var(--gold)">${G.counts.scholarship}</span>íšŒ /
    ê¸ˆì§€ ì§€ì‹ <span style="color:#b18cff">${G.counts.forbidden}</span>íšŒ
  `;

  const cols = { mana:'#9050ff', know:'#40b0ff', body:'#40e880', social:'#ffaa40' };
  document.getElementById('en-stats').innerHTML = [
    ['âœ¨ ë§ˆë ¥', G.stats.mana, 'mana'],
    ['ğŸ“š ì§€ì‹', G.stats.know, 'know'],
    ['ğŸ’ª ì²´ë ¥', G.stats.body, 'body'],
    ['ğŸ’¬ ì‚¬êµ', G.stats.social, 'social'],
    ['ğŸ’° ê³¨ë“œ', G.gold, 'social']
  ].map(([l, v, k]) =>
    `<div class="en-st" style="border-color:${cols[k] || '#e8b830'};color:${cols[k] || '#e8b830'}">${l}<br>${v}</div>`
  ).join('');

  clearSave();
  showScreen('screen-ending');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ì €ì¥ / ë¶ˆëŸ¬ì˜¤ê¸°
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

function loadGame() {
  const v3 = localStorage.getItem(SAVE_KEY);
  const v2 = localStorage.getItem('mageAcad_v2');

  if (v3) {
    G = normalizeGameState(JSON.parse(v3));
  } else if (v2) {
    G = migrateLegacySave(JSON.parse(v2));
    saveGame();
  } else {
    return;
  }

  startGame();
}

function restartGame() {
  showScreen('screen-title');
}
</script>
</body>
</html>
